---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wth.
--- DateTime: 2021/12/4 12:05
--- 消息接收器

require "Battle/OutInterface/ProtoCodeEnum"

COMMAND = {};

--外部调用收到msg bytes（客户端用）
---@param id number 协议id
---@param bytes table 协议二进制数据
function COMMAND.ReceiveMsgBytes(id, bytes)

    print("COMMAND.ReceiveMsgBytes " .. id)
    
    local tab = nil;
    if id == 12001 then
        tab = assert(pb.decode("msg.TestBattleDemo_S2C", bytes))
        print(require "protobuf.serpent".block(tab))
        return
    elseif id == 11020 then
        tab = assert(pb.decode("msg.BattleSoloTest_S2C", bytes))
        print("msg.BattleSoloTest_S2C " .. require "protobuf.serpent".block(tab))
        InitBattleData(tab.battleEnterInfo)
        return
    elseif id == 11003 then
        tab = assert(pb.decode("msg.BattleLogin", bytes))
        SetClientPlayerId(tab.uid)
        return
    end

    local proto = PROTO_CODE_MAP[tostring(id)];
    if proto ~= nil then
        tab = assert(pb.decode(proto:GetName(),bytes));
        if tab ~=nil then
            fightCoreLua:ReceiveMsg(nil,id,tab)
        end
    end

end

--外部调用收到msg table(服务器用)
---@param uid number 发送协议的玩家id，如果是战斗房间消息该值为nil
---@param id number 协议id
---@param table table 协议
function COMMAND.ReceiveMsgTable(uid, id, table)
    fightCoreLua:ReceiveMsg(uid, id, table)
end

--向客户端显示发送消息 客户端逻辑核心调用
---@param id number 协议id
---@param protoName string 协议名
---@param tab table 协议
function COMMAND.SendCommandToClientView(id, protoName, tab)
    local bytes = assert(pb.encode(protoName, tab));
    CS_SendCommandToClient(id, bytes)
end

--向客户端发送消息 服务器端逻辑核心调用
---@param uid number 发送协议的玩家id
---@param id number 协议id
---@param table table 协议
function COMMAND.SendCommandThroughServerToClient(uid, id, table)
    ServerLuaBattle:invokeSendMessageByLua(uid, id, table);
end

--向客户端广播消息 服务器端逻辑核心调用
---@param battleId number 战斗id
---@param id number 协议id
---@param table table 协议
function COMMAND.BroadcastCommandToClientTable(battleId, id, table)
    ServerLuaBattle:invokeBroadcastMessageByLua(battleId, id, table);
end



---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/3/28 22:41

require "Lib/class"
require "Battle/Logic/Buff/BattleBuffEffect"

---@class FallObjectBattleBuffEffect : BattleBuffEffect
---@field buffInstanceId number 配置Id
---@field targetParam number 最终目标参数
---@field customParam ElementLightningBall 自定义参数
---@field nextTriggerTime number 下次触发时间
---@field triggerCount number 触发次数
FallObjectBattleBuffEffect = class(BattleBuffEffect, 'FallObjectBattleBuffEffect');

function FallObjectBattleBuffEffect:ctor(_buffInstanceId)

    self.buffInstanceId = _buffInstanceId;
    self.targetParam = 0;
    self.customParam = nil;
    self.nextTriggerTime = 0;
    self.triggerCount = 0;
end

---附加buff
---@public
---@param _battleObject BattleObjectBase 战斗物体
---@param _battleBuff BattleBuff buff实体
function FallObjectBattleBuffEffect:Attach(_battleObject, _battleBuff)
    ---@type BuffAndActionInstance
    local _buffInstance = _battleObject:GetBattleRoom().inputDataSource:GetDict("BuffAndActionInstance", self.buffInstanceId)
    if _buffInstance then
        ---@type BuffAndActionTemplate
        local _buffTemplate = _battleObject:GetBattleRoom().inputDataSource:GetDict("BuffAndActionTemplate", _buffInstance.templateId)
        if _buffTemplate then
            ---@type number
            self.fallObjectId = _buffTemplate.behindParam[BATTLE_CONST.FALL_OBJECT_BUFF_ID_INDEX]
            if self.fallObjectId then
                self.fallObjectId = Mathf.Floor(self.fallObjectId)
            end
            ---@type number
            self.fallObjectCount = _buffTemplate.behindParam[BATTLE_CONST.FALL_OBJECT_BUFF_COUNT_INDEX]
            if self.fallObjectCount then
                self.fallObjectCount = Mathf.Floor(self.fallObjectCount)
            end
            ---@type number
            self.fallObjectOwnerType = _buffTemplate.behindParam[BATTLE_CONST.FALL_OBJECT_OWNER_TYPE_INDEX]
            if self.fallObjectOwnerType then
                self.fallObjectOwnerType = Mathf.Floor(self.fallObjectOwnerType)
            end
        end
    end
end

---触发buff
---@public
---@param _battleObject BattleObjectBase 战斗物体
---@param _battleBuff BattleBuff buff实体
---@param _stackNum number 堆叠数量
---@param _isUnitChangeLeader boolean 是否为玩家buff换人操作
function FallObjectBattleBuffEffect:Trigger(_battleObject, _battleBuff, _stackNum, _isUnitChangeLeader)
    if not _isUnitChangeLeader then
        self.triggerCount = self.triggerCount + 1;
    end

    local battleRoom = _battleObject:GetBattleRoom()

    -- 默认掉落物归属被上buff的单位
    local ownerNetId = _battleObject:GetParentUnit():GetNetId()
    local ownerObjId = _battleObject:GetParentUnit():GetCurrentHeroObjectId()
    if self.fallObjectOwnerType and self.fallObjectOwnerType == 1 then
        -- 配置1则掉落物归属释放者
        ownerNetId = _battleBuff.castUnitId
        ownerObjId = _battleBuff.castObjId
    end

    battleRoom.fallObjectManager:DropFallObjectByUnit(self.fallObjectId, self.fallObjectCount, ownerNetId, ownerObjId, _battleObject:GetParentUnit():GetNetId(), false)
end

---释放buff
---@public
---@param _battleObject BattleObjectBase 战斗物体
---@param _battleBuff BattleBuff buff实体
---@param _stackNum number 堆叠数量
function FallObjectBattleBuffEffect:Release(_battleObject, _battleBuff, _stackNum)

end

---@public
---@return number buff类型Id
function FallObjectBattleBuffEffect:GetId()
    return 42;
end

return FallObjectBattleBuffEffect;
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/9/27 11:44

require "Lib/class"
require "Battle/Logic/Buff/BattleBuffEffect"

---@class CoverShieldBattleBuffEffect : BattleBuffEffect
---@field buffInstanceId number 配置Id
---@field castParam table 施法者参数
---@field customParam table 自定义参数
---@field nextTriggerTime number 下次触发时间
---@field triggerCount number 触发次数
---@field castObjId number 施法者objId
---@field castUnitId number 施法者unitId
CoverShieldBattleBuffEffect = class(BattleBuffEffect, 'CoverShieldBattleBuffEffect');

function CoverShieldBattleBuffEffect:ctor(_buffInstanceId)

    self.buffInstanceId = _buffInstanceId;
    self.castParam = nil;
    self.customParam = nil;
    self.nextTriggerTime = 0;
    self.triggerCount = 0;
    self.__cachedIndex = nil

end

---触发buff
---@public
---@param _battleObject BattleObjectBase 战斗物体
---@param _battleBuff BattleBuff buff实体
---@param _stackNum number 堆叠数量
---@param _isUnitChangeLeader boolean 是否为玩家buff换人操作
function CoverShieldBattleBuffEffect:Trigger(_battleObject, _battleBuff, _stackNum,_isUnitChangeLeader)
    if not _isUnitChangeLeader then
        self.triggerCount = self.triggerCount + 1;
    end

    ---@type BattleUnitCom_CoverShield
    local _unitShieldCom = _battleObject:GetParentUnit():GetComponent(BattleUnitComponentType.CoverShield)
    if not _unitShieldCom then return end
    local _value = self:GetCastParam(_battleObject) * _stackNum
    self.__cachedIndex = _unitShieldCom:AddCoverShield(_battleObject:GetObjectId(), _battleBuff.buffGroupId, _value, _value)
    --LogTools.LogByLevel(LogLevel.log, "CheckShield", "CoverShieldBattleBuffEffect:Trigger", "netId", _battleObject:GetParentUnit():GetNetId(), "objID", _battleObject:GetObjectId(), "self.__cachedIndex", self.__cachedIndex)
end

---释放buff
---@public
---@param _battleObject BattleObjectBase 战斗物体
---@param _battleBuff BattleBuff buff实体
---@param _stackNum number 堆叠数量
---@param _isTimeOver boolean 是否时间到
function CoverShieldBattleBuffEffect:Release(_battleObject, _battleBuff, _stackNum, _isTimeOver)
    if not self.__cachedIndex then return end
    ---@type BattleUnitCom_CoverShield
    local _unitShieldCom = _battleObject:GetParentUnit():GetComponent(BattleUnitComponentType.CoverShield)
    if not _unitShieldCom then return end
    _unitShieldCom:RemoveCoverShield(self.__cachedIndex, false)
    self.__cachedIndex = nil
    --LogTools.LogByLevel(LogLevel.log, "CheckShield", "CoverShieldBattleBuffEffect:Release", "netId", _battleObject:GetParentUnit():GetNetId(), "objID", _battleObject:GetObjectId())
end

---@public
---@return number buff类型Id
function CoverShieldBattleBuffEffect:GetId()
    return 50;
end

---静态方法,生成施法者自定义参数
---@public
---@param _battleObjectBase BattleObjectBase 释放buff的单位
---@param _buffInstanceId number BuffAndActionInstance表id
---@param _param table 自定义参数
---@return table 施法者参数
function CoverShieldBattleBuffEffect:GenerateCostCustomParam(_battleObjectBase, _buffInstanceId, _param)
    return _param;
end

return CoverShieldBattleBuffEffect;
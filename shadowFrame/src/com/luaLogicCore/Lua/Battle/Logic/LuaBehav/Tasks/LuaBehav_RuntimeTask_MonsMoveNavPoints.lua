---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/09/28 11:09
--- Describe: 导航点移动节点
---

---@class LuaBehav_MonsMoveNavPointsParam : table
LuaBehav_MonsMoveNavPointsParam = class(nil, "LuaBehav_MonsMoveNavPointsParam")
function LuaBehav_MonsMoveNavPointsParam:ctor(_netId, _configTask)
	self.netId = _netId
	self.moveType = _configTask.moveType
	self.navPointsList = _configTask.navPointsList
	self.loopAtEnd = _configTask.loopAtEnd
end

---@class LuaBehav_RuntimeTask_MonsMoveNavPoints : LuaBehav_RuntimeTask
LuaBehav_RuntimeTask_MonsMoveNavPoints = class(LuaBehav_RuntimeTask, "LuaBehav_RuntimeTask_MonsMoveNavPoints")

function LuaBehav_RuntimeTask_MonsMoveNavPoints:OnStart()
	--LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_RuntimeTask_MonsMoveNavPoints", "OnStart", "self.configTask", dumpTableEx(self.configTask))
	self:__OnStart()
	self.__timeTotal = self.configTask.time
	self.__startTime = self.battleRoom.behaviorManager:GetUnitTimeCnt()
	self.__listen = false
	self:RegistListenEvent(LuaBehav_Define_TaskListenEnum.MoveNavPointsEnd)
	if not self.__paramData then
		self.__paramData = LuaBehav_MonsMoveNavPointsParam.New(self.netId, self.configTask)
	end
	self.__callRet = BEHAVIOR_ACTION.MonsMoveNavPoints(self.battleId, self.__paramData)
	--LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_RuntimeTask_MonsMoveNavPoints", "self.__callRet", self.__callRet)
end

function LuaBehav_RuntimeTask_MonsMoveNavPoints:OnListenEvent()
	self.__listen = true
end

function LuaBehav_RuntimeTask_MonsMoveNavPoints:OnUpdate(_deltaTime)
	if not self.__callRet then
		--LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_RuntimeTask_MonsMoveNavPoints Call Failure")
		self:__SetTaskState(LuaBehav_Define_TaskState.Failure)
		return LuaBehav_Define_TaskState.Failure
	end
	
	--监听到位置消息
	if self.__listen then
		self:__SetTaskState(LuaBehav_Define_TaskState.Success)
		BEHAVIOR_ACTION.MonsStopMoveNavPoints(self.battleId, self.netId)
		----LogTools.LogByLevel(LogLevel.log, "LuaBehav_RuntimeTask_MonsMoveNavPoints __OnMoveToPathPoint stop receive event")
		return LuaBehav_Define_TaskState.Success
	end

	--时间到达
	if self.__timeTotal > 0 then
		local _timeDis = self.battleRoom.behaviorManager:GetUnitTimeCnt() - self.__startTime
		if _timeDis > self.__timeTotal then
			self:__SetTaskState(LuaBehav_Define_TaskState.Success)
			--LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_RuntimeTask_MonsMoveNavPoints stop timeout")
			BEHAVIOR_ACTION.MonsStopMoveNavPoints(self.battleId, self.netId)
			return LuaBehav_Define_TaskState.Success
		end
	end
	
	self:__SetTaskState(LuaBehav_Define_TaskState.Running)
	return LuaBehav_Define_TaskState.Running
end

-- 节点被打断时调用
function LuaBehav_RuntimeTask_MonsMoveNavPoints:OnAbort()
	self:__OnAbort()
	self.__listen = false
	self:RemoveListenEvent(LuaBehav_Define_TaskListenEnum.MoveNavPointsEnd)
	BEHAVIOR_ACTION.MonsStopMoveNavPoints(self.battleId, self.netId)
end

function LuaBehav_RuntimeTask_MonsMoveNavPoints:OnExit()
	----LogTools.LogByLevel(LogLevel.log, "LuaBehav_RuntimeTask_MonsMoveNavPoints __OnMoveToPathPoint OnExit")
	self:__OnExit()
	self.__listen = false
	self:RemoveListenEvent(LuaBehav_Define_TaskListenEnum.MoveNavPointsEnd)
end

return LuaBehav_RuntimeTask_MonsMoveNavPoints
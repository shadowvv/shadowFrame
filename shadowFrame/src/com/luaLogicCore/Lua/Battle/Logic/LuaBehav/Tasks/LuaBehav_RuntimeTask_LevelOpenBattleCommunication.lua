---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/04/14 11:16
--- Describe: 调用打开战斗内通讯
---

---@class LuaBehav_RuntimeTask_LevelOpenBattleCommunication : LuaBehav_RuntimeTask
LuaBehav_RuntimeTask_LevelOpenBattleCommunication = class(LuaBehav_RuntimeTask, "LuaBehav_RuntimeTask_LevelOpenBattleCommunication")

function LuaBehav_RuntimeTask_LevelOpenBattleCommunication:OnStart()
	self:__OnStart()
	
	local _talkGroupId = self.configTask.talkGroupId
	--self.__timeAcc = 0
	self.__startTime = self.battleRoom.behaviorManager:GetLevelTimeCnt()
	local _timeTotal = 0
	if self.configTask.waitToEnd then
		---@type InBattleDialog
		local _inBattleDilogXls = self.battleRoom.inputDataSource:GetDict("InBattleDialog", _talkGroupId)
		if not _inBattleDilogXls then 
			--LogTools.LogByLevel(LogLevel.log, "LuaBehav_RuntimeTask_LevelOpenBattleCommunication", "error TalkGroupId: ", _talkGroupId)
			self.__callRet = false
			return
		end
		local _contentList = _inBattleDilogXls.content
		for i = 1, #_contentList do
			---@type InBattleDialogContent
			local _contentXls = self.battleRoom.inputDataSource:GetDict("InBattleDialogContent", _contentList[i])
			if _contentXls then
				_timeTotal = _timeTotal + _contentXls.residencetime + _contentXls.intervaltime
			end
		end
	end
	self.__timeTotal = _timeTotal
	--LogTools.LogByLevel(LogLevel.log, "LuaBehav_RuntimeTask_LevelOpenBattleCommunication", "_timeTotal", _timeTotal, "_talkGroupId", _talkGroupId)
	self.__callRet = BEHAVIOR_ACTION.LevelOpenBattleCommunication(self.battleId, _talkGroupId)
end

function LuaBehav_RuntimeTask_LevelOpenBattleCommunication:OnUpdate(_deltaTime)
	if not self.__callRet then
		self:__SetTaskState(LuaBehav_Define_TaskState.Failure)
		return LuaBehav_Define_TaskState.Failure
	end

	local _timeDis = self.battleRoom.behaviorManager:GetLevelTimeCnt() - self.__startTime
	if _timeDis > self.__timeTotal then
		self:__SetTaskState(LuaBehav_Define_TaskState.Success)
		return LuaBehav_Define_TaskState.Success
	end
	
	--self.__timeAcc = self.__timeAcc + _deltaTime
	--if self.__timeAcc > self.__timeTotal then
	--	self:__SetTaskState(LuaBehav_Define_TaskState.Success)
	--	return LuaBehav_Define_TaskState.Success
	--end
	
	self:__SetTaskState(LuaBehav_Define_TaskState.Running)
	return LuaBehav_Define_TaskState.Running
end

return LuaBehav_RuntimeTask_LevelOpenBattleCommunication
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2021/12/21 17:52
--- Describe: 用于加载和解析配置的工具类
---

---@class LuaBehav_Loader : table
LuaBehav_Loader = class(nil, "LuaBehav_Loader")
function LuaBehav_Loader:ctor(_battleId)
	self.battleId = _battleId
end
function LuaBehav_Loader:OnUpdate(_deltaTime) end

function LuaBehav_Loader:Init(_behavRuntimeMgr)
	self.behavRunTimeMgr = _behavRuntimeMgr
end

-- 加载配置内容
---@param _configBehavTree LuaBehav_ConfigBehavTree
---@return LuaBehav_RuntimeBehavTree
function LuaBehav_Loader:Load(_treeName, _configBehavTree, _index, _belongType, _netId)
	if CheckLogLevel(LogLevel.log) then
		LogTools.LogByLevel(LogLevel.log, "LuaBehav_Loader", "Load", "_treeName", _treeName)
	end
	
	local _rootTask = _configBehavTree.rootTask
	if not _rootTask then return nil end
	
	---@type LuaBehav_RuntimeBehavTree
	local _behavTree = LuaBehav_RuntimeBehavTree.New()
	_behavTree:Init(self.battleId, self.behavRunTimeMgr, _index, _configBehavTree.treeVariableDic, _belongType, _netId, _treeName)
	self:__LoadConfigTask(_behavTree, _rootTask, nil, 1)
	
	return _behavTree
end

-- 解析配置生成的任务数据
---@param _behavTree LuaBehav_RuntimeBehavTree
---@param _configTask LuaBehav_ConfigTask
---@param _parentRuntimeTask LuaBehav_RuntimeTask
function LuaBehav_Loader:__LoadConfigTask(_behavTree, _configTask, _parentRuntimeTask, _cntInParent)
	local _taskList = _behavTree.taskList
	local _parentTaskIndex = -1
	if _parentRuntimeTask then _parentTaskIndex = _parentRuntimeTask.index end
	
	---@type LuaBehav_RuntimeTask
	local _runtimeTask = self:__InstantiateRuntimeTaskByType(_configTask.nodeType)
	if not _runtimeTask then return end
	table.insert(_taskList, _runtimeTask)
	local _taskIndex = #_taskList
	
	_runtimeTask:Init(self.battleId, _behavTree, _taskIndex, _parentTaskIndex, _configTask, _cntInParent)
	----LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_Loader", "_taskIndex", _taskIndex, "_configTask.type", _configTask.nodeType, LuaBehav_DebugTool.GetTaskTypeDesc(_configTask.nodeType), "_runtimeTask:IsConditionalTask()", _runtimeTask:IsConditionalTask())
	if _runtimeTask:IsConditionalTask() and _cntInParent == 1 then
		local _shouldCheckInterrupt = false
		--if _parentRuntimeTask then
		--	--LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_Loader", "_parentRuntimeTask", _parentRuntimeTask.index, --LogTools.GetEnumTableDesc(LuaBehav_Define_TaskType, _parentRuntimeTask.type), "_parentRuntimeTask:CheckInterruptTag()", _parentRuntimeTask:CheckInterruptTag())
		--end
		while _parentRuntimeTask and _parentRuntimeTask:CheckInterruptTag() do
			_shouldCheckInterrupt = true
			_behavTree.conditionInterruptionParentIndexDic[_taskIndex] = _parentTaskIndex
			_parentTaskIndex = _behavTree.parentIndexDic[_parentTaskIndex]
			_parentRuntimeTask = _behavTree:GetTask(_parentTaskIndex)
		end
		----LogTools.LogByLevel(LogLevel.log, "CheckLuaBehav", "LuaBehav_Loader", "_shouldCheckInterrupt", _shouldCheckInterrupt)
		if _shouldCheckInterrupt then
			table.insert(_behavTree.conditionalTaskList, _runtimeTask)
			--table.insert(_behavTree.conditionalStateList, LuaBehav_Define_TaskState.Failure)
		end
	elseif _runtimeTask:IsForceReevaluateTask() then
		table.insert(_behavTree.forceReevaluateTaskList, _runtimeTask)
	end

	if _runtimeTask:IsInterruptTask() then
		_behavTree.interruptionTaskDic[_taskIndex] = _runtimeTask
	end
	
	local _childList = _configTask.children
	local _childCount = #_childList
	if _childCount > 0 then
		self:__LoadConfigTaskOfParentType(_behavTree, _configTask, _childList, _childCount, _runtimeTask)
	else
		self:__LoadConfigTaskOfChildType(_behavTree, _configTask, _taskIndex)
	end
	
	
end

-- 解析配置的父任务类型数据
---@param _behavTree LuaBehav_RuntimeBehavTree
---@param _configParentTask LuaBehav_ConfigTask
---@param _childList LuaBehav_ConfigTask[]
---@param _parentRuntimeTask LuaBehav_RuntimeTask
function LuaBehav_Loader:__LoadConfigTaskOfParentType(_behavTree, _configParentTask, _childList, _childCount, _parentRuntimeTask)
	local _parentIndex = _parentRuntimeTask.index
	local _treeTaskList = _behavTree.taskList --这里长度是会变的
	local _childIndexList = _parentRuntimeTask.childIndexList
	local _childStateList = _parentRuntimeTask.childStateList
	local _hideChildList = _parentRuntimeTask.childHideList
	local _defaultChildState = LuaBehav_Define_TaskState.Inactive
	for i = 1, _childCount do
		local _configTask = _childList[i]
		local _childIndex = #_treeTaskList + 1
		table.insert(_childIndexList, _childIndex)
		table.insert(_childStateList, _defaultChildState)
		table.insert(_hideChildList, false)
		self:__LoadConfigTask(_behavTree, _configTask, _parentRuntimeTask, i)
	end
end

-- 解析配置的子任务类型数据
---@param _behavTree LuaBehav_RuntimeBehavTree
---@param _configTask LuaBehav_ConfigTask
function LuaBehav_Loader:__LoadConfigTaskOfChildType(_behavTree, _configTask)
	
end

-- 根据类型实例化具体对应的类
---@param _type LuaBehav_Define_TaskType
function LuaBehav_Loader:__InstantiateRuntimeTaskByType(_type)
	local _ret
	if LuaBehav_Define_TaskType.Root == _type then
		_ret = LuaBehav_RuntimeTask_Root.New()
	elseif LuaBehav_Define_TaskType.PrintLog == _type then
		_ret = LuaBehav_RuntimeTask_PrintLog.New()
	elseif LuaBehav_Define_TaskType.Wait == _type then
		_ret = LuaBehav_RuntimeTask_Wait.New()
	elseif LuaBehav_Define_TaskType.SetVariable == _type then
		_ret = LuaBehav_RuntimeTask_SetVariable.New()
	elseif LuaBehav_Define_TaskType.CheckVariable == _type then
		_ret = LuaBehav_RuntimeTask_CheckVariable.New()
	elseif LuaBehav_Define_TaskType.RandomInt == _type then
		_ret = LuaBehav_RuntimeTask_RandomInt.New()
	elseif LuaBehav_Define_TaskType.StopTree == _type then
		_ret = LuaBehav_RuntimeTask_StopTree.New()
	elseif LuaBehav_Define_TaskType.Sequence == _type then
		_ret = LuaBehav_RuntimeTask_Sequence.New()
	elseif LuaBehav_Define_TaskType.Select == _type then
		_ret = LuaBehav_RuntimeTask_Select.New()
	elseif LuaBehav_Define_TaskType.ProbabilitySelect == _type then
		_ret = LuaBehav_RuntimeTask_ProbabilitySelect.New()
	elseif LuaBehav_Define_TaskType.Parallel == _type then
		_ret = LuaBehav_RuntimeTask_Parallel.New()
	elseif LuaBehav_Define_TaskType.ConditionChecker == _type then
		_ret = LuaBehav_RuntimeTask_ConditionChecker.New()
	elseif LuaBehav_Define_TaskType.ConditionComparer == _type then
		_ret = LuaBehav_RuntimeTask_ConditionComparer.New()
	elseif LuaBehav_Define_TaskType.Repeat == _type then
		_ret = LuaBehav_RuntimeTask_Repeat.New()
	elseif LuaBehav_Define_TaskType.Event == _type then
		_ret = LuaBehav_RuntimeTask_Event.New()
	elseif LuaBehav_Define_TaskType.IntVariableCalc == _type then
		_ret = LuaBehav_RuntimeTask_IntVariableCalc.New()
	elseif LuaBehav_Define_TaskType.ConditionGroup == _type then
		_ret = LuaBehav_RuntimeTask_ConditionGroup.New()
	----------------------------------------------------------------------------------------------------------------
	elseif LuaBehav_Define_TaskType.LevelDropMons == _type then
		_ret = LuaBehav_RuntimeTask_LevelDropMons.New()
	elseif LuaBehav_Define_TaskType.LevelDropPlayerHero == _type then
		_ret = LuaBehav_RuntimeTask_LevelDropPlayerHero.New()
	elseif LuaBehav_Define_TaskType.LevelTimerOperation == _type then
		_ret = LuaBehav_RuntimeTask_LevelTimerOperation.New()
	elseif LuaBehav_Define_TaskType.LevelDropPerformanceHero == _type then
		_ret = LuaBehav_RuntimeTask_LevelDropPerformanceHero.New()
	elseif LuaBehav_Define_TaskType.LevelDropUnit == _type then
		_ret = LuaBehav_RuntimeTask_LevelDropUnit.New()
	elseif LuaBehav_Define_TaskType.LevelForceEnd == _type then
		_ret = LuaBehav_RuntimeTask_LevelForceEnd.New()
	elseif LuaBehav_Define_TaskType.LevelPlayPlot == _type then
		_ret = LuaBehav_RuntimeTask_LevelPlayPlot.New()
	elseif LuaBehav_Define_TaskType.LevelSetUnitProp == _type then
		_ret = LuaBehav_RuntimeTask_LevelSetUnitProp.New()
	elseif LuaBehav_Define_TaskType.LevelKillUnit == _type then
		_ret = LuaBehav_RuntimeTask_LevelKillUnit.New()
	elseif LuaBehav_Define_TaskType.LevelOperateAi == _type then
		_ret = LuaBehav_RuntimeTask_LevelOperateAi.New()
	elseif LuaBehav_Define_TaskType.LevelCheckUnitDead == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckUnitDead.New()
	elseif LuaBehav_Define_TaskType.LevelOpenWarningUI == _type then
		_ret = LuaBehav_RuntimeTask_LevelOpenWarningUi.New()
	elseif LuaBehav_Define_TaskType.LevelTriggerChecker == _type then
		_ret = LuaBehav_RuntimeTask_LevelTriggerChecker.New()
	elseif LuaBehav_Define_TaskType.LevelRemoveTrigger == _type then
		_ret = LuaBehav_RuntimeTask_LevelRemoveTrigger.New()
	elseif LuaBehav_Define_TaskType.LevelOpenBattleCommunication == _type then
		_ret = LuaBehav_RuntimeTask_LevelOpenBattleCommunication.New()
	elseif LuaBehav_Define_TaskType.LevelCheckUnitState == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckUnitState.New()
	elseif LuaBehav_Define_TaskType.LevelCheckUnitProp == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckUnitProp.New()
	elseif LuaBehav_Define_TaskType.LevelTrigGuideUiOperate == _type then
		_ret = LuaBehav_RuntimeTask_LevelTrigGuideUIOperate.New()
	elseif LuaBehav_Define_TaskType.LevelTrigNormalUiOperate == _type then
		_ret = LuaBehav_RuntimeTask_LevelTrigNormalUIOperate.New()
	elseif LuaBehav_Define_TaskType.LevelTrigControllerOperate == _type then
		_ret = LuaBehav_RuntimeTask_LevelTrigControllerOperate.New()
	elseif LuaBehav_Define_TaskType.LevelTrigUnitBuff == _type then
		_ret = LuaBehav_RuntimeTask_LevelTrigUnitBuff.New()
	elseif LuaBehav_Define_TaskType.LevelCheckPlayerController == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckPlayerController.New()
	elseif LuaBehav_Define_TaskType.LevelCheckPlayerSkillState == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckPlayerSkillState.New()
	elseif LuaBehav_Define_TaskType.LevelCheckPlotState == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckPlotState.New()
	elseif LuaBehav_Define_TaskType.LevelChangeSceneObjState == _type then
		_ret = LuaBehav_RuntimeTask_LevelChangeSceneObjState.New()
	elseif LuaBehav_Define_TaskType.LevelRemoveSceneObj == _type then
		_ret = LuaBehav_RuntimeTask_LevelRemoveSceneObj.New()
	elseif LuaBehav_Define_TaskType.LevelChangeBGM == _type then
		_ret = LuaBehav_RuntimeTask_LevelChangeBGM.New()
	elseif LuaBehav_Define_TaskType.LevelCheckEleReact == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckEleReact.New()
	elseif LuaBehav_Define_TaskType.LevelCheckEleAttach == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckEleAttach.New()
	elseif LuaBehav_Define_TaskType.LevelCheckBattleGuide == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckGuide.New()
	elseif LuaBehav_Define_TaskType.LevelRemoveTargetPoint == _type then
		_ret = LuaBehav_RuntimeTask_LevelRemoveTargetPoint.New()
	elseif LuaBehav_Define_TaskType.LevelSetWaveValue == _type then
		_ret = LuaBehav_RuntimeTask_LevelSetWaveValue.New()
	elseif LuaBehav_Define_TaskType.LevelKillUnitInTrigger == _type then
		_ret = LuaBehav_RuntimeTask_LevelKillUnitInTrigger.New()
	elseif LuaBehav_Define_TaskType.LevelCheckSingleUnitDead == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckSingleUnitDead.New()
	elseif LuaBehav_Define_TaskType.LevelCheckSceneObjState == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckSceneObjState.New()
	elseif LuaBehav_Define_TaskType.LevelTagOperate == _type then
		_ret = LuaBehav_RuntimeTask_LevelTagOperate.New()
	elseif LuaBehav_Define_TaskType.LevelChangeTimeCount == _type then
		_ret = LuaBehav_RuntimeTask_LevelChangeTimeCount.New()
	elseif LuaBehav_Define_TaskType.LevelCheckMonsBuff == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckMonsBuff.New()
	elseif LuaBehav_Define_TaskType.LevelBreakMonsSkill == _type then
		_ret = LuaBehav_RuntimeTask_LevelBreakMonsSkill.New()
	elseif LuaBehav_Define_TaskType.LevelCheckEleBreak == _type then
		_ret = LuaBehav_RuntimeTask_LevelCheckEleBreak.New()
	----------------------------------------------------------------------------------------------------------------
	elseif LuaBehav_Define_TaskType.MonsDeath == _type then
		_ret = LuaBehav_RuntimeTask_MonsDeath.New()
	elseif LuaBehav_Define_TaskType.MonsPatrol == _type then
		_ret = LuaBehav_RuntimeTask_MonsPatrol.New()
	elseif LuaBehav_Define_TaskType.MonsSelectTarget == _type then
		_ret = LuaBehav_RuntimeTask_MonsSelectTarget.New()
	elseif LuaBehav_Define_TaskType.MonsChaseCurTarget == _type then
		_ret = LuaBehav_RuntimeTask_MonsChaseCurTarget.New()
	elseif LuaBehav_Define_TaskType.MonsEscapeCurTarget == _type then
		_ret = LuaBehav_RuntimeTask_MonsEscapeCurTarget.New()
	elseif LuaBehav_Define_TaskType.MonsFaceCurTarget == _type then
		_ret = LuaBehav_RuntimeTask_MonsFaceCurTarget.New()
	elseif LuaBehav_Define_TaskType.MonsAddBuff == _type then
		_ret = LuaBehav_RuntimeTask_MonsAddBuff.New()
	elseif LuaBehav_Define_TaskType.MonsMoveTowards == _type then
		_ret = LuaBehav_RuntimeTask_MonsMoveTowards.New()
	elseif LuaBehav_Define_TaskType.MonsMoveTowards_2 == _type then
		_ret = LuaBehav_RuntimeTask_MonsMoveTowards_2.New()
	elseif LuaBehav_Define_TaskType.MonsRotateTowards == _type then
		_ret = LuaBehav_RuntimeTask_MonsRotateTowards.New()
	elseif LuaBehav_Define_TaskType.MonsPropCondition == _type then
		_ret = LuaBehav_RuntimeTask_MonsPropCondition.New()
	elseif LuaBehav_Define_TaskType.MonsCastSkill == _type then
		_ret = LuaBehav_RuntimeTask_MonsCastSkill.New()
	elseif LuaBehav_Define_TaskType.MonsSetProperty == _type then
		_ret = LuaBehav_RuntimeTask_MonsSetProperty.New()
	elseif LuaBehav_Define_TaskType.MonsChangeStage == _type then
		_ret = LuaBehav_RuntimeTask_MonsChangeStage.New()
	elseif LuaBehav_Define_TaskType.MonsChangeStateParamId == _type then
		_ret = LuaBehav_RuntimeTask_MonsChangeStateParamId.New()
	elseif LuaBehav_Define_TaskType.MonsChaseSubordinate == _type then
		_ret = LuaBehav_RuntimeTask_ChaseSubordinate.New()
	elseif LuaBehav_Define_TaskType.SceneObjChangeSelfState == _type then
		_ret = LuaBehav_RuntimeTask_SceneObjChangeSelfState.New()
	elseif LuaBehav_Define_TaskType.BoundaryListenerChecker == _type then
		_ret = LuaBehav_RuntimeTask_BoundaryListenerChecker.New()
	elseif LuaBehav_Define_TaskType.MonsRotateAxisLock == _type then
		_ret = LuaBehav_RuntimeTask_MonsRotateAxisLock.New()
	elseif LuaBehav_Define_TaskType.UnitCheckBuff == _type then
		_ret = LuaBehav_RuntimeTask_UnitCheckBuff.New()
	elseif LuaBehav_Define_TaskType.MoveNavPoints == _type then
		_ret = LuaBehav_RuntimeTask_MonsMoveNavPoints.New()
	elseif LuaBehav_Define_TaskType.MonsChangeBlockState == _type then
		_ret = LuaBehav_RuntimeTask_UnitChangeBlockState.New()
	elseif LuaBehav_Define_TaskType.SceneObjCheckSelfState == _type then
		_ret = LuaBehav_RuntimeTask_SceneObjCheckSelfState.New()
	elseif LuaBehav_Define_TaskType.SceneObjChangeCoinPoints == _type then
		_ret = LuaBehav_RuntimeTask_SceneObjChangeCoinPoints.New()
	elseif LuaBehav_Define_TaskType.UnitAddBuffInBoundary == _type then
		_ret = LuaBehav_RuntimeTask_UnitAddBuffInBoundary.New()
	elseif LuaBehav_Define_TaskType.MonsBreakSkill == _type then
		_ret = LuaBehav_RuntimeTask_MonsBreakSkill.New()
	elseif LuaBehav_Define_TaskType.SceneObjCheckHit == _type then
		_ret = LuaBehav_RuntimeTask_SceneObjCheckHit.New()
	elseif LuaBehav_Define_TaskType.MonsClearLastHurtFromTag == _type then
		_ret = LuaBehav_RuntimeTask_MonsClearLastHurtFromTag.New()
	elseif LuaBehav_Define_TaskType.MonsChangeWarriorState == _type then
		_ret = LuaBehav_RuntimeTask_MonsChangeWarriorState.New()
	elseif LuaBehav_Define_TaskType.MonsGetDisFromTarget == _type then
		_ret = LuaBehav_RuntimeTask_MonsGetDisFromTarget.New()
	elseif LuaBehav_Define_TaskType.UnitCallFallingDown == _type then
		_ret = LuaBehav_RuntimeTask_UnitCallFallindDown.New()
	elseif LuaBehav_Define_TaskType.UnitCheckHasShield == _type then
		_ret = LuaBehav_RuntimeTask_UnitCheckShield.New()
	elseif LuaBehav_Define_TaskType.UnitCloseShield == _type then
		_ret = LuaBehav_RuntimeTask_UnitCloseShield.New()
	elseif LuaBehav_Define_TaskType.MonsFixHeight == _type then
		_ret = LuaBehav_RuntimeTask_MonsFixHeight.New()
	elseif LuaBehav_Define_TaskType.UnitCheckSummonedExist == _type then
		_ret = LuaBehav_RuntimeTask_UnitCheckSummoned.New()
	elseif LuaBehav_Define_TaskType.UnitCallSummoned == _type then
		_ret = LuaBehav_RuntimeTask_UnitCallSummoned.New()
	elseif LuaBehav_Define_TaskType.UnitStartChangeStage == _type then
		_ret = LuaBehav_RuntimeTask_UnitStartChangeStage.New()
	----------------------------------------------------------------------------------------------------------------
	elseif LuaBehav_Define_TaskType.BattleGuideTrigger == _type then
		_ret = LuaBehav_RuntimeTask_BattleGuideTrigger.New()
	----------------------------------------------------------------------------------------------------------------
	elseif LuaBehav_Define_TaskType.Inverter == _type then
		_ret = LuaBehav_RuntimeTask_Inverter.New()
	elseif LuaBehav_Define_TaskType.Filter == _type then
		_ret = LuaBehav_RuntimeTask_Filter.New()
	elseif LuaBehav_Define_TaskType.TimeOut == _type then
		_ret = LuaBehav_RuntimeTask_TimeOut.New()
	else
		
	end
	return _ret
end

return LuaBehav_Loader
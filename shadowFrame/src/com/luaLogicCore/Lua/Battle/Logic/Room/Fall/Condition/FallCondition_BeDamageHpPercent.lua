---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hejincheng.
--- DateTime: 2022/3/8 15:34

-- 受伤：单位生命小于等于X%

require "Lib/class"

---@class FallCondition_BeDamageHpPercent : FallConditionBase
FallCondition_BeDamageHpPercent = class(FallConditionBase, 'FallCondition_BeDamageHpPercent');

function FallCondition_BeDamageHpPercent:ctor()
end

-- 掉落事件回调
---@public
---@param _unit BattleUnitBase
---@param _battleLogicEvent BattleLogicEventV2
function FallCondition_BeDamageHpPercent:OnTriggerEvent(_unit, _battleLogicEvent)
    if not _unit or not _battleLogicEvent then
        return
    end
    ---@type BattleObjCom_Drop
    local _comDrop = _unit:GetCurrentHeroObject():GetComponent(BattleObjectComponentType.Drop)
    if not _comDrop then
        return
    end
    local _fallDictDataArr = _comDrop:GetFallDictDatas(FallConditionEnum.OBJECT_HP)
    if not _fallDictDataArr or #_fallDictDataArr == 0 then
        return
    end
    ---@type BattleObjCom_Property
    local _comProp = _unit:GetCurrentHeroObject():GetComponent(BattleObjectComponentType.Property)
    if not _comProp then
        return
    end
    if not _battleLogicEvent.eventTriggerParam then
        return
    end

    ---@type number
    local _oldHp = _battleLogicEvent.eventTriggerParam.targetOldHp
    if _oldHp == nil then
        return
    end

    ---@type number
    local _curHp = _comProp:GetPropertyByName(BattlePropertyEnum.Hp_Cur)
    if _battleLogicEvent.eventTriggerParam.targetCurHp then
        _curHp = _battleLogicEvent.eventTriggerParam.targetCurHp
    end

    ---@type number
    local _attackerNetId = 0
    if _battleLogicEvent.eventTriggerParam.sourceNetId then
        _attackerNetId = _battleLogicEvent.eventTriggerParam.sourceNetId
    end

    ---@type number
    local _elementId = 0
    if _battleLogicEvent.eventTriggerParam.elementId then
        _elementId = _battleLogicEvent.eventTriggerParam.elementId
    end

    if _oldHp <= _curHp then
        -- 仅处理掉血情况
        return
    end

    local _maxHp = _comProp:GetPropertyByName(BattlePropertyEnum.Hp_Max)
    local triggerFallData = {}
    for _, fallDictData in pairs(_fallDictDataArr) do
        local _ratio = fallDictData.conditionParam
        local _targetHp = 0
        if _maxHp then
            _targetHp = _maxHp * _ratio
        end
        if _targetHp >= _curHp and _targetHp <= _oldHp then
            -- 扣血量经过目标血量值
            table.insert(triggerFallData, fallDictData)
        end
    end

    for _, fallDictData in pairs(triggerFallData) do
        -- 检测并生效
        _comDrop:CheckDropAndEffect(fallDictData, _elementId, _attackerNetId)
    end
end

return FallCondition_BeDamageHpPercent;
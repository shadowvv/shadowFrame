---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/07/05 16:09
--- Describe: 区域触发单位
---

---@class BattleUnit_AreaTrigger : BattleUnitBase
BattleUnit_AreaTrigger = class(BattleUnitBase, "BattleUnit_AreaTrigger")

---@public
---@param _battleCreateUnitParam BattleCreateUnitParam
function BattleUnit_AreaTrigger:Init(_battleCreateUnitParam, _areaTriggerObjectDic, _currentObjectId)
	--LogTools.LogByLevel(LogLevel.log, "BattleUnit_AreaTrigger", "Init", "netId", _battleCreateUnitParam.netId, "_battleCreateUnitParam.maxDis", _battleCreateUnitParam.maxDis)
	self:__Init(BattleUnitType.AreaTrigger, _battleCreateUnitParam, _areaTriggerObjectDic, _currentObjectId)
	
	--todo: 临时处理一下区域的最大移动距离, 将来需要完整的逻辑端物理碰撞解决方案
	self.maxDis = _battleCreateUnitParam.maxDis
	self.poweredMaXDis = self.maxDis * self.maxDis
	
	self:__InitComponents(_battleCreateUnitParam)
	self.__actionManager:Spawn()
end

---@private
---@param _battleCreateUnitParam BattleCreateUnitParam
function BattleUnit_AreaTrigger:__InitComponents(_battleCreateUnitParam)
	---@type BattleUnitComponentManager
	local _comManager = self:GetBattleRoom().battleUnitManager:GetUnitComponentManager()
	
	---@type BattleUnitCom_TagSelector
	local _tagCom = _comManager:AddComponent(self, BattleUnitComponentType.TagSelector)
	_tagCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = _comManager:AddComponent(self, BattleUnitComponentType.UnitProp)
	_unitPropCom:Init(self)

	---@type BattleUnitCom_Subordination
	local _subordinationCom = _comManager:AddComponent(self, BattleUnitComponentType.Subordination)
	_subordinationCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_Camp
	local _campCom = _comManager:AddComponent(self, BattleUnitComponentType.Camp)
	_campCom:Init(self, _battleCreateUnitParam.firstCamp, _battleCreateUnitParam.secCamp)
	
	---@type BattleUnitCom_Hatred
	local _hatredCom = _comManager:AddComponent(self, BattleUnitComponentType.Hatred)
	_hatredCom:Init(self)
	
	---@type BattleUnitCom_CoverShield
	local _shieldCom = _comManager:AddComponent(self, BattleUnitComponentType.CoverShield)
	_shieldCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_PathFind
	local _pathFindCom = _comManager:AddComponent(self, BattleUnitComponentType.PathFind)
	_pathFindCom:Init(self)
	
	---@type BattleUnitCom_Rotate
	local _rotateCom = _comManager:AddComponent(self, BattleUnitComponentType.Rotate)
	_rotateCom:Init(self)
	
	---@type BattleUnitCom_Behav
	local _behavCom = _comManager:AddComponent(self, BattleUnitComponentType.Behav)
	_behavCom:Init(self)
	
end

---@public
function BattleUnit_AreaTrigger:OnCreate()
	---@type BattleObjCom_AreaTrigger
	local _areaCom = self:GetCurrentHeroObject():GetComponent(BattleObjectComponentType.AreaTrigger)
	_areaCom:OnCreate()
end

---@public
---@return boolean
function BattleUnit_AreaTrigger:CheckFromNetIdAndDicId(_fromNetId, _dicId)
	---@type BattleObjCom_AreaTrigger
	local _areaCom = self:GetCurrentHeroObject():GetComponent(BattleObjectComponentType.AreaTrigger)
	return _areaCom and _areaCom:CheckFromNetIdAndDicId(_fromNetId, _dicId)
end

------------------------------------------------------------------------------------------------------------------------
---@public
function BattleUnit_AreaTrigger:GetL2SMessageData()
	---@type BattleCreateUnitParam
	local _createParam = self:GetCreateParam()
	
	local _areaTriggerUnitInfo_L2V = {}
    _areaTriggerUnitInfo_L2V.netId = self:GetNetId()
	_areaTriggerUnitInfo_L2V.alive = self.__alive
	_areaTriggerUnitInfo_L2V.createTime = self.__createTime
	_areaTriggerUnitInfo_L2V.fromNetId = _createParam.subordinatedNetId
	_areaTriggerUnitInfo_L2V.fromObjId = _createParam.subordinatedObjId
	---@type BattleUnitCom_Camp
	local _campCom = self:GetComponent(BattleUnitComponentType.Camp)
	_areaTriggerUnitInfo_L2V.firstCamp = _campCom:GetFirstCamp()
	_areaTriggerUnitInfo_L2V.secCamp = _campCom:GetSecCamp()
    _areaTriggerUnitInfo_L2V.currentObjectId = self:GetCurrentHeroObjectId()
	_areaTriggerUnitInfo_L2V.sourceType = _createParam.sourceType
	_areaTriggerUnitInfo_L2V.sourceId = _createParam.sourceId
	_areaTriggerUnitInfo_L2V.playerSkillNodeId = _createParam.skillNodeId
	
	local _objectInfoList = {}
	---@type BattleObject_AreaTrigger[]
	local _objectList = self:GetTypeObjectList(BattleObjectType.AreaTrigger)
	for i = 1, #_objectList do
		local _areaTriggerObject = _objectList[i]
		table.insert(_objectInfoList, _areaTriggerObject:GetL2SMessageData())
	end
	_areaTriggerUnitInfo_L2V.objectList = _objectInfoList

	local _moveInfo = {}
	---@type ActionStateManage
	local _actionManager = self:GetActionManager()
	_moveInfo.position = _actionManager:GetPosition()
	_moveInfo.rotation = _actionManager:GetRotation()
	_moveInfo.v = _actionManager:GetVelocity()
	_moveInfo.accelerate = Vector3.zero_local()
	_moveInfo.moveParam = Vector3.zero_local()
	_moveInfo.cameraParam = Vector3.zero_local()
	_moveInfo.type = 0
	_areaTriggerUnitInfo_L2V.moveInfo = _moveInfo
	
	_areaTriggerUnitInfo_L2V.scale = _actionManager:GetScale()
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = self.__componentDic[BattleUnitComponentType.UnitProp]
	_areaTriggerUnitInfo_L2V.UnitProps = _unitPropCom and _unitPropCom:GetCreateSyncMessage_L2V() or {}
	---@type BattleUnitCom_CoverShield
	local _shieldCom = self.__componentDic[BattleUnitComponentType.CoverShield]
	_areaTriggerUnitInfo_L2V.coverShieldInfo = _shieldCom and _shieldCom:GetCreateSyncMessage_L2V()
	_areaTriggerUnitInfo_L2V.targetPointId = self:GetOriginalGenerateInfo().targetPointId
	--LogTools.LogByLevel(LogLevel.log, "CheckArea", "BattleUnit_AreaTrigger GetL2SMessageData", dumpTableEx(_areaTriggerUnitInfo_L2V))
	return _areaTriggerUnitInfo_L2V
end

return BattleUnit_AreaTrigger
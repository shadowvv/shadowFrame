---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2021/12/16 11:05
--- 服务器logic_core输出数据处理器

require "Lib/class"
require "Battle/Logic/Room/Component/OutputDataProcessor"
require "Battle/Logic/Room/Component/Server/ServerOutputData"

---@class ServerOutputDataProcessor : OutputDataProcessor 服务器logic_core输出数据处理器
ServerOutputDataProcessor = class(OutputDataProcessor,'ServerOutputDataProcessor');

function ServerOutputDataProcessor:ctor()
    self.fullData = ServerOutputData:New();
    self.currentFrameId = 0;
    self.traceBackList = {};
    self.playerCurrentFrameId = {};
end

--初始化
---@public
---@param _battleId number 战斗id
function ServerOutputDataProcessor:Init(_battleId)
    self.battleId = _battleId;
end

-- 注册玩家
function ServerOutputDataProcessor:RegisterPlayer(_playerId)
    table.insert(self.playerCurrentFrameId,_playerId,0);
end

-- 创建玩家角色
---@public
---@param _createPlayerCharacter2View table 创建角色协议
function ServerOutputDataProcessor:CreatePlayerCharacter(_createPlayerCharacter2View)

end

-- 添加输出数据
---@public
---@param _battleOutputData table logic_core每帧输出的数据
function ServerOutputDataProcessor:AddOutputData(_battleOutputData)
    COMMAND.BroadcastCommandToClientTable(self.battleId,PROTO_CODE_ENUM.BATTLE_OUTPUT_DATA:GetId(),_battleOutputData);
end

-- 玩家确认数据一致
---@public
---@param _playerId number 玩家id
---@param _frameId number 确认帧号
function ServerOutputDataProcessor:onPlayerConfirmFrame(_playerId,_frameId)
    if self.playerCurrentFrameId._playerId ~= nil then
        self.playerCurrentFrameId._playerId = _frameId;
    end
    for index, value in ipairs(self.playerCurrentFrameId) do
        if value < _frameId then
            return;
        end
    end
    self:DiscardOldData(_frameId);
end

-- 淘汰无用数据
---@public
---@param _oldFrameId number 淘汰帧号
function ServerOutputDataProcessor:DiscardOldData(_oldFrameId)
    for index, value in ipairs(self.traceBackList) do
        if index <= _oldFrameId then
            self.fullData = self.fullData + value;
        end
    end

    for i = self.currentFrameId, _oldFrameId, 1 do
        table.remove(self.traceBackList,i);
    end 

    self.currentFrameId = _oldFrameId;
end

-- 玩家回溯数据
---@public
---@param _playerId number 玩家id
---@param _frameId number 确认帧号
function ServerOutputDataProcessor:TraceBack(_playerId,_frameId)
    local traceBackData = ServerOutputData:New();
    traceBackData = self.fullData + traceBackData;
    for index, value in ipairs(self.traceBackList) do
        if index <= _frameId then
            traceBackData = traceBackData + value;
        end
    end
    return traceBackData;
end

return ServerOutputDataProcessor;
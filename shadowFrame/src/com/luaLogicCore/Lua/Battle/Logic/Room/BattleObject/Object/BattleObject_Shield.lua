---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/08/09 14:17
--- Describe:
---

---@class BattleObject_Shield : BattleObjectBase
BattleObject_Shield = class(BattleObjectBase, "BattleObject_Shield")

---@public
---@param _parentUnit BattleUnitBase
---@param _createBattleUnitParam BattleCreateUnitParam
function BattleObject_Shield:Init(_battleId, _objectId, _parentUnit, _createBattleUnitParam)
    self:__Init(_battleId, _parentUnit, _objectId, _createBattleUnitParam.dicId)
    self:__InitComponents(_createBattleUnitParam)
	self:__InitStackTypeDic()
end

---@private
---@param _createBattleUnitParam BattleCreateUnitParam
function BattleObject_Shield:__InitComponents(_createBattleUnitParam)
    ---@type BattleObjectComponentCreator
	local componentCreator = self:GetBattleRoom().battleObjectManager:GetObjectComponentCreator()

    ---@type BattleObjCom_Config
	local _cfgCom = componentCreator:__CreateComponent(BattleObjectComponentType.Config)
	_cfgCom:Init(self)
    self:AddComponent(_cfgCom)

    ---@type BattleObjCom_Property
	local _propCom = componentCreator:__CreateComponent(BattleObjectComponentType.Property)
	_propCom:Init(self, _cfgCom:GetInstanceXls(), _createBattleUnitParam) --护罩的属性暂时需要先读区域自身的Instance表
    self:AddComponent(_propCom)
	
	---@type BattleObjCom_LifeCtrl
    local _lifeCom = componentCreator:__CreateComponent(BattleObjectComponentType.LifeCtrl)
    _lifeCom:Init(self, _createBattleUnitParam)
    self:AddComponent(_lifeCom)
	
	---@type BattleObjCom_Block
	local _blockCom = componentCreator:__CreateComponent(BattleObjectComponentType.Block)
	_blockCom:Init(self)
	self:AddComponent(_blockCom)

    ---@type BattleObjCom_Element_V2
    local _elementCom = componentCreator:__CreateComponent(BattleObjectComponentType.Element)
    _elementCom:Init(self)
    self:AddComponent(_elementCom)
	
    -----@type BattleObjCom_Buff
    local _buffCom = componentCreator:__CreateComponent(BattleObjectComponentType.Buff)
    _buffCom:Init(self)
    self:AddComponent(_buffCom)
	
	--
    -----@type BattleObjCom_HitValue
    --local _hitValueCom = componentCreator:__CreateComponent(BattleObjectComponentType.HitValue)
    --_hitValueCom:Init(self, _leaderBattleInfo)
    --self:AddComponent(_hitValueCom)
	--
    -----@type BattleObjCom_Drop
    --local _dropCom = componentCreator:__CreateComponent(BattleObjectComponentType.Drop)
    --_dropCom:Init(self, {})
    --self:AddComponent(_dropCom)
end

---堆叠替换类型
---@private
function BattleObject_Shield:__InitStackTypeDic()
	---@type Shield
	local _shieldXls = self:GetInstanceXls()
	local _dic = {}
	for _, _type in pairs(_shieldXls.stackableType) do
		_dic[_type] = 1
	end
	self.__stackTypeDic = _dic
end

---@public
function BattleObject_Shield:CheckInStackTypeDicByList(_stackTypeList)
	for _, _type in pairs(_stackTypeList) do
		if self.__stackTypeDic[_type] then return true end
	end
	return false
end

---@public
function BattleObject_Shield:SetDead(_deadType)
	---@type BattleUnitCom_Subordination
	local _subordinateCom = self:GetParentUnit():GetComponent(BattleUnitComponentType.Subordination)
	
	---@type BattleObjectBase
	local _subordinationObj = _subordinateCom:GetSubordinatedObject()
	---@type BattleObjCom_Buff
	local _subordinationBuffCom = _subordinationObj:GetComponent(BattleObjectComponentType.Buff)
	---@type Shield
	local _shieldXls = self:GetInstanceXls()
	
	if _subordinationBuffCom then
		--死亡时从持有者移除的buff
		local _removeBuffGroupList = _shieldXls.endTargetReduceBuff
		--LogTools.LogByLevel(LogLevel.log, "shieldDeadRemove", "_removeBuffGroupList", dumpTableEx(_removeBuffGroupList))
		if #_removeBuffGroupList > 0 then
			for _, _buffGroupId in pairs(_removeBuffGroupList) do
				if _buffGroupId and _buffGroupId ~= 0 then
					_subordinationBuffCom:RemoveBuffByGroupId(_buffGroupId)
				end
			end
		end

		--死亡时添加给持有者的buff
		local _addBuffGroupList = _shieldXls.endTargeAddBuff
		if _deadType == LuaBehav_Define_DeadType.DeadNormal then
			_addBuffGroupList = _shieldXls.breakTargeAddBuff or {}
		else
			_addBuffGroupList = _shieldXls.endTargeAddBuff
		end
		
		--LogTools.LogByLevel(LogLevel.log, "shieldDeadAdd", "_addBuffGroupList", dumpTableEx(_addBuffGroupList))
		if #_addBuffGroupList > 0 then
			for _, _buffGroupId in pairs(_addBuffGroupList) do
				if _buffGroupId and _buffGroupId ~= 0 then
					_subordinationBuffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _subordinationObj, nil, nil))
				end
			end
		end
	end
	
	---@type BattleUnitCom_Subordination
	local _parentSubordinateCom = _subordinateCom:GetSubordinatedUnitComponent(BattleUnitComponentType.Subordination)
	if _parentSubordinateCom then
		_parentSubordinateCom:RemoveManagedObjByObjId(self:GetDicId(), self:GetObjectId(), self:GetObjectType())
	end
	
	self:__SetDead(_deadType)
end
------------------------------------------------------------------------------------------------------------------------
function BattleObject_Shield:GetL2SMessageData()
	local _ShieldObjectInfo_L2V = {}
    _ShieldObjectInfo_L2V.objectId = self:GetObjectId()
	_ShieldObjectInfo_L2V.alive = not self.__isDead
	---@type BattleObjCom_LifeCtrl
	local _lifeCom = self:GetComponent(BattleObjectComponentType.LifeCtrl)
	_ShieldObjectInfo_L2V.createTime = _lifeCom:GetCreateTime()
	---@type BattleObjCom_Property
	local _propCom = self:GetComponent(BattleObjectComponentType.Property)
	_ShieldObjectInfo_L2V.property = _propCom:GetProtoHash()
	_ShieldObjectInfo_L2V.curStage = _propCom:GetCurStage()
	_ShieldObjectInfo_L2V.eleWeakTypeList = _propCom:GetEleWeakTypeList()
	_ShieldObjectInfo_L2V.blockInfoList = self:__CollectBlockDataList()
	return _ShieldObjectInfo_L2V
end

return BattleObject_Shield
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/6/9 17:37

require "Lib/class"
require "Battle/Logic/Room/BattleLogicEvent/BattleLogicEventV2"

---@class BattleLogicBeDamageEvent : BattleLogicEventV2
---@field eventType number 事件类型
---@field battleId number 战斗id
---@field eventCompareParam table 事件参数
---@field eventTriggerParam table 事件透传参数
---@field netId number 事件产出单位Id
---@field objectId number 事件产出物体Id
BattleLogicBeDamageEvent = class(BattleLogicEventV2, 'BattleLogicBeDamageEvent');

---@param _eventType number 事件类型
---@param _battleId number 战斗id
---@param _eventCompareParam table 事件参数
---@param _eventTriggerParam table 事件透传参数
---@param _netId number 事件产出单位Id
---@param _objectId number 事件产出物体Id
function BattleLogicBeDamageEvent:ctor(_eventType, _eventCompareParam, _eventTriggerParam, _netId, _objectId, _battleId)
    self.battleId = _battleId
    self.eventType = _eventType;
    self.eventCompareParam = _eventCompareParam;
    self.eventTriggerParam = _eventTriggerParam;
    self.netId = _netId;
    self.objectId = _objectId;
    self.survival = 0;
end

---检测事件触发，默认没有比较参数
---@public
---@param _eventCompareParam table 比较参数
function BattleLogicBeDamageEvent:CheckEventTrigger(_eventCompareParam)
    return true;
end

---事件回调，默认为空
---@public
function BattleLogicBeDamageEvent:FireEvent()
    if self.survival == 0 then
        local battleRoom = GetBattleRoom(self.battleId)
        -- 数据收集
        battleRoom.dataCollectManager:OnDamage(
        self.eventTriggerParam.targetNetId,
        self.eventTriggerParam.sourceNetId,
        self.eventTriggerParam.damage,
        self.eventTriggerParam.damageSourceId,
        self.eventTriggerParam.damageSourceType,
        self.eventTriggerParam.isCritical,
        self.eventTriggerParam.elementId,
        self.eventTriggerParam.targetOldHp,
        self.eventTriggerParam.targetCurHp
        )
        -- 掉落物
        battleRoom.fallObjectManager:OnTriggerBeDamageEvent(self.eventTriggerParam.targetNetId, self)
        if not self.eventTriggerParam.trigEvent then
            return;
        end
        -- 技能
        ---@type BattleUnitBase
        local sourceUnit = battleRoom.battleUnitManager:GetUnit(self.eventTriggerParam.sourceNetId);
        if sourceUnit then
            for i, v in pairs(sourceUnit:GetAllObjectDic()) do
                ---@type BattleObjCom_Skill
                local skillComp = v:GetComponent(BattleObjectComponentType.Skill)
                if skillComp then
                    skillComp:OnHitTarget(self.eventTriggerParam.sourceNetId,self.eventTriggerParam.sourceObjectId,self.eventTriggerParam.targetNetId,self.eventTriggerParam.targetObjectId,self.eventTriggerParam.targetType,self.eventTriggerParam.damageSourceId,self.eventTriggerParam.damageSourceType,self.eventTriggerParam.damage,self.eventTriggerParam.damageType,self.eventTriggerParam.isCritical,self.eventTriggerParam.targetDead,self.eventTriggerParam.hurtDisReduceEnum,self.eventTriggerParam.isWeakness,self.eventTriggerParam.curAttachEleId,self.eventTriggerParam.isAccumulatedAttack);
                end
            end
        end
        ---@type BattleUnitBase
        local targetUnit = battleRoom.battleUnitManager:GetUnit(self.eventTriggerParam.targetNetId);
        if targetUnit then
            for i, v in pairs(targetUnit:GetAllObjectDic()) do
                ---@type BattleObjCom_Skill
                local skillComp = v:GetComponent(BattleObjectComponentType.Skill)
                if skillComp then
                    skillComp:OnBeHit(self.eventTriggerParam.sourceNetId,self.eventTriggerParam.sourceObjectId,self.eventTriggerParam.targetNetId,self.eventTriggerParam.targetObjectId,self.eventTriggerParam.targetType,self.eventTriggerParam.damageSourceId,self.eventTriggerParam.damageSourceType,self.eventTriggerParam.damage,self.eventTriggerParam.damageType,self.eventTriggerParam.isCritical,self.eventTriggerParam.targetDead,self.eventTriggerParam.hurtDisReduceEnum,self.eventTriggerParam.isWeakness,self.eventTriggerParam.curAttachEleId);
                end
            end
            
            --打断采集
            ---@type BattleUnitCom_Collector
            local _collectCom = targetUnit:GetComponent(BattleUnitComponentType.Collector)
            if _collectCom then
                _collectCom:SetAbortTag()
            end
        end
    end
end

---@public
---检测互斥事件
---@param _event BattleLogicEventV2 新事件
---@return boolean 是否互斥
function BattleLogicBeDamageEvent:CheckMutexEvent(_event)
    return false;
end

---检测移除事件，默认事件会在trigger之后的下一帧被移除
---@public
function BattleLogicBeDamageEvent:CheckRemoveEvent()
    self.survival = self.survival + 1;
    if self.survival > 1 then
        return true;
    end
    return false;
end

---生成比较参数
---@public
function BattleLogicBeDamageEvent:GenerateCompareParam(_param);
    local compareParam = {};
    return compareParam;
end

return BattleLogicBeDamageEvent;
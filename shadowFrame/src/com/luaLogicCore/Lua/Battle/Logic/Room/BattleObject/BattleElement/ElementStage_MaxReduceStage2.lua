---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hejincheng.
--- DateTime: 2022/3/2 19:06

require "Lib/class"

---@class ElementStage_MaxReduceStage2 : ElementStageBase
ElementStage_MaxReduceStage2 = class(ElementStageBase, 'ElementStage_MaxReduceStage2');

function ElementStage_MaxReduceStage2:Init(_index, _stageManager)
    self:__Init(_index, _stageManager)
    local _elementStackEffect = self.elementStackEffect
    self.initSpeed = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_REDUCE_SPEED_M_INDEX] or 0
    self.speedAccTime = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_REDUCE_TIME_E_INDEX] or 0
    self.maxSpeed = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_REDUCE_SPEED_N_INDEX] or 0
    self.maxAddRatio = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_MAX_ADD_RATIO_INDEX] or 0
    self.curSpeed = self.initSpeed
    self.reduceSpeedAcc = (self.maxSpeed - self.initSpeed) / self.speedAccTime
end

function ElementStage_MaxReduceStage2:OnEnter()
    self:__OnEnter()
    if CheckLogLevel(LogLevel.log) and LogTools.ElementLog then
        local _targetObjectLog = "[" .. tostring(self.battleObjComElement.__object:GetDicId()) .. "]"
        local _unit = self.battleObjComElement.__object:GetParentUnit()
        if _unit:GetNetId() then
            _targetObjectLog = "[" .. self.battleRoom.battleUnitManager:GetBattleUnitTypeName(_unit:GetUnitType()) .. "][" .. _unit:GetNetId() .. "]" .. _targetObjectLog
        end
        LogTools.LogByLevel(LogLevel.log, "元素", "元素[" .. GetBattleElementNameById(self.elementId) .. "]", "目标" .. _targetObjectLog, "<color=#00FF00>进入创伤加速衰减阶段</color>",
                "衰减速度初始速度", self.initSpeed,
                "衰减速度加速时间", self.speedAccTime,
                "衰减速度最终值", self.maxSpeed,
                "衰减速度加速度", self.reduceSpeedAcc,
                "当前时间", TimeUtils.battleNow(self.battleId),
                "元素当前值", self.battleObjComElement:GetElementCurrentValue(self.elementId)
        )
    end
end

--- 获取衰减速度
---@return number 添加元素压缩系数
function ElementStage_MaxReduceStage2:GetAddElementRatio()
    return self.maxAddRatio
end

--- 获取衰减速度
function ElementStage_MaxReduceStage2:GetReduceSpeed()
    if self.curSpeed >= self.maxSpeed then
        return self.maxSpeed
    end
    local _addReduceSpeed = self.reduceSpeedAcc * self.runTime
    self.curSpeed = self.initSpeed + _addReduceSpeed
    return Mathf.Min(self.curSpeed, self.maxSpeed)
end

---@param _time number 时间
---@return number 元素量
function ElementStage_MaxReduceStage2:__ConvertTimeToValue(_time)
    -- 加速衰减时间
    local _accTime = Mathf.Max(self.speedAccTime - self.runTime, 0)
    -- 匀速衰减时间
    local _constTime = _time - _accTime

    local _maxValue = self.stateManager.battleObjComElement:GetElementMaxValue(self.elementId)
    local _value = 0
    local _finalSpeed = self.curSpeed

    if _accTime > 0 then
        -- 1.加速衰减元素量 = (初始速度 + 最终速度) / 2 * 时间
        local _initSpeed = self.curSpeed
        _finalSpeed = _initSpeed + self.reduceSpeedAcc * _accTime
        local _avgSpeed = (_initSpeed + _finalSpeed) / 2
        _value = _value + _avgSpeed * _maxValue * _accTime
    end
    if _constTime > 0 then
        -- 2.匀速衰减元素量 = 最终速度 * 时间
        _value = _value + _finalSpeed * _maxValue * _constTime
    end
    return _value
end

---@param _value number 元素量
---@return number 时间
function ElementStage_MaxReduceStage2:__ConvertValueToTime(_value)
    local _maxValue = self.stateManager.battleObjComElement:GetElementMaxValue(self.elementId)
    local _time = 0

    local _remainValue = _value
    local _finalSpeed = self.curSpeed

    local _accTime = self.speedAccTime - self.runTime
    if _accTime > 0 then
        -- 加速阶段转换
        local _accValue = self:__ConvertTimeToValue(_accTime)
        if _accValue >= _remainValue then
            -- 全加速
            local _initSpeed = self.curSpeed
            _finalSpeed = _initSpeed + self.reduceSpeedAcc * _accTime
            -- 加速衰减时间 = 加速衰减元素量 / (初始速度 + 最终速度) / 2
            return _remainValue / (_initSpeed + _finalSpeed) * _maxValue / 2
        end
        -- 1.加速衰减时间
        _time = _time + _accTime
        _remainValue = _remainValue - _accValue
    end
    if _remainValue > 0 then
        -- 匀速阶段转换
        -- 2.匀速衰减时间 = 匀速衰减元素量 * 2 / 最终速度
        _time = _time + _remainValue / _finalSpeed * _maxValue
    end
    return _time
end

return ElementStage_MaxReduceStage2;

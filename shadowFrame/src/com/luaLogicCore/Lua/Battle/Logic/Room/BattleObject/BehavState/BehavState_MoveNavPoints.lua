---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/09/28 11:23
--- Describe: 导航点移动
---

---@class BehavState_MoveNavPoints : BattleUnit_PathFindCaller
BehavState_MoveNavPoints = class(BattleUnit_PathFindCaller, "BehavState_MoveNavPoints")

---@public
---@param _behavCom BattleUnitCom_Behav
function BehavState_MoveNavPoints:Init(_behavCom)
	---@private
	---@type BattleUnitCom_Behav
	self.__behavCom = _behavCom
	self:__Init(_behavCom:GetUnit(), 1000, 15)
	self:__InitStateUseInfos()
	self.__running = false
end

---初始化一些当前behavState需要使用的专属信息
---@private
function BehavState_MoveNavPoints:__InitStateUseInfos()
	---记录当前已经到达了第几个点
	---默认第0个
	---@private
	self.__arrivedCnt = 0
	---@private
	---@type Vector3[]
	self.__pointList = {}
	---@private
	---@type boolean
	self.__loop = false
end
------------------------------------------------------------------------------------------------------------------------
---开启行为
---@public
---@param _param LuaBehav_MonsMoveNavPointsParam
function BehavState_MoveNavPoints:Start(_pointList, _loop)
	--LogTools.LogByLevel(LogLevel.log, "behavState", "BehavState_MoveNavPoints:Start", "Start", "netId", self.__unitSelf:GetNetId(), "_pointList", dumpTableEx(_pointList))
	if self.__running then return end
	self.__running = true

	self.__pointList = _pointList
	self.__loop = _loop
	self.__comPathFind:Open(true)
	self:CallPathFind()
end

---结束行为
---@public
function BehavState_MoveNavPoints:Stop()
	--LogTools.LogByLevel(LogLevel.log, "behavState", "BehavState_MoveNavPoints:Stop", "Start", "netId", self.__unitSelf:GetNetId())
	self:ReleaseHitBlockParams()
	if not self.__running then return end
	self.__running = false
	
	self.__comPathFind:Open(false)
	self.__comPathFind:StopPathFind()
	self.__actionManagerSelf:Exit(self.__actionManagerSelf:GetCurrentMoveState(), false)
end

------------------------------------------------------------------------------------------------------------------------
---@public
function BehavState_MoveNavPoints:CallPathFind()
	self:__ResetReFindTimeCount()
	self.__comPathFind:StartPathFind(self, true)
end

---获取目标点
---@public
---@param _v3Receiver Vector3 用于接收结果的vec3
---@return boolean 是否成功获取到目标点
function BehavState_MoveNavPoints:GetTargetPos(_v3Receiver)
	--LogTools.LogByLevel(LogLevel.log, "BehavState_MoveNavPoints:GetTargetPos", "self.__arrivedCnt", self.__arrivedCnt, "self.__pointList[self.__arrivedCnt + 1]", self.__pointList[self.__arrivedCnt + 1])
	local _curTarget = self.__pointList[self.__arrivedCnt + 1]
	if not _curTarget then return false end
	Vector3.Copy(_v3Receiver, _curTarget)
	return true
end

---寻路移动结束时的回调
---@public
function BehavState_MoveNavPoints:FindPathCallBack()
	--LogTools.LogByLevel(LogLevel.log, "BehavState_MoveNavPoints:FindPathCallBack", "self.__arrivedCnt", self.__arrivedCnt, "self.__behavCom:GetBattleRoom().behaviorProcessor:CheckMonsAIHost()", self.__behavCom:GetBattleRoom().behaviorProcessor:CheckMonsAIHost())
	if not self.__behavCom:GetBattleRoom().behaviorProcessor:CheckMonsAIHost() then return end

	self.__arrivedCnt = self.__arrivedCnt + 1
	if self.__arrivedCnt >= #self.__pointList then
		if self.__loop then
			self.__arrivedCnt = 0
			self:CallPathFind()
		else
			self.__behavCom:GetBattleRoom().behaviorManager:PostTaskListenEvent(self.__behavCom:GetTreeIndex(), LuaBehav_Define_TaskListenEnum.MoveNavPointsEnd)
		end
	else
		self:CallPathFind()
	end
end

------------------------------------------------------------------------------------------------------------------------
---@public
function BehavState_MoveNavPoints:CheckRunning()
	return self.__running
end

---@public
function BehavState_MoveNavPoints:Clear()
	self:Stop()
	self.__behavCom = nil
	self.__arrivedCnt = nil
	self.__pointList = nil
	self.__loop = nil
	self.__running = nil
	self:__Clear()
end
return BehavState_MoveNavPoints
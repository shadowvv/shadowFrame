---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/07/12 16:48
--- Describe: 召唤物单位
---

---@class BattleUnit_SummonedMons : BattleUnitBase
BattleUnit_SummonedMons = class(BattleUnitBase, "BattleUnit_SummonedMons")

---@param _battleCreateUnitParam BattleCreateUnitParam
function BattleUnit_SummonedMons:Init(_battleCreateUnitParam, _objectDic, _currentObjectId)
	--LogTools.LogByLevel(LogLevel.log, "BattleUnit_SummonedMons", "Init", "netId", _battleCreateUnitParam.netId)
	self:__Init(BattleUnitType.SummonedMons, _battleCreateUnitParam, _objectDic, _currentObjectId)
	self:__InitComponents(_battleCreateUnitParam)
	self:__AddToSubordinatedUnit()
	self.__actionManager:Spawn()
end

---@private
---@param _battleCreateUnitParam BattleCreateUnitParam
function BattleUnit_SummonedMons:__InitComponents(_battleCreateUnitParam)
	---@type BattleUnitComponentManager
	local _comManager = self:GetBattleRoom().battleUnitManager:GetUnitComponentManager()
	
	---@type BattleUnitCom_TagSelector
	local _tagCom = _comManager:AddComponent(self, BattleUnitComponentType.TagSelector)
	_tagCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = _comManager:AddComponent(self, BattleUnitComponentType.UnitProp)
	_unitPropCom:Init(self)
	
	---@type BattleUnitCom_Subordination
	local _subordinationCom = _comManager:AddComponent(self, BattleUnitComponentType.Subordination)
	_subordinationCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_Camp
	local _campCom = _comManager:AddComponent(self, BattleUnitComponentType.Camp)
	_campCom:Init(self, _battleCreateUnitParam.firstCamp, _battleCreateUnitParam.secCamp)
	
	---@type BattleUnitCom_Hatred
	local _hatredCom = _comManager:AddComponent(self, BattleUnitComponentType.Hatred)
	_hatredCom:Init(self)
	
	---@type BattleUnitCom_CoverShield
	local _shieldCom = _comManager:AddComponent(self, BattleUnitComponentType.CoverShield)
	_shieldCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_PathFind
	local _pathFindCom = _comManager:AddComponent(self, BattleUnitComponentType.PathFind)
	_pathFindCom:Init(self)
	
	---@type BattleUnitCom_Rotate
	local _rotateCom = _comManager:AddComponent(self, BattleUnitComponentType.Rotate)
	_rotateCom:Init(self)
	
	---@type BattleUnitCom_PositionSet
	local _posSetCom = _comManager:AddComponent(self, BattleUnitComponentType.PosSet)
	_posSetCom:Init(self)
	
	---@type BattleUnitCom_Behav
	local _behavCom = _comManager:AddComponent(self, BattleUnitComponentType.Behav)
	_behavCom:Init(self)
	
end

---将自身添加到召唤者的从属列表中
---@private
function BattleUnit_SummonedMons:__AddToSubordinatedUnit()
	---@type BattleUnitCom_Subordination
	local _subordinateCom = self:GetComponent(BattleUnitComponentType.Subordination)
	---@type BattleUnitCom_Subordination
	local _parentSubordinateCom = _subordinateCom:GetSubordinatedUnitComponent(BattleUnitComponentType.Subordination)
	
	for _, _obj in pairs(self:GetTypeObjectList(BattleObjectType.SummonedMons)) do
		_parentSubordinateCom:AddManagedObj(_obj:GetDicId(), _obj:GetObjectId(), _obj:GetObjectType())
	end
end

---添加关卡初始buff和被动
function BattleUnit_SummonedMons:AddLevelInitBuffAndTalent()
	---@type BattleUnitCom_Subordination
	local _subordinationCom = self:GetComponent(BattleUnitComponentType.Subordination)
	if not _subordinationCom then return end

	---@type BattleUnitCom_Camp
	local _campCom = self:GetComponent(BattleUnitComponentType.Camp)
	---目前只管玩家阵营的召唤物
	if not _campCom:CheckFirstCamp(BattleUnitCampType.Player) then return end

	---@type NewLevelInstance
	local _levelXls = self.battleRoom.battleLevelManager.levelConfigManager:GetLevelInstanceXls()
	local _playerSummondBuffList = _levelXls.playerSummonedBuff
	local _playerSummondTalentList = _levelXls.playerSummonedTalent
	
	local _buffGroupId
	local _talentId
	---@type BattleObjCom_Buff
	local _buffCom
	---@type BattleObjCom_Skill
	local _skillCom
	local _objectList = self:GetTypeObjectList(BattleObjectType.SummonedMons)
	for _, _obj in pairs(_objectList) do
		
		_buffCom = _obj:GetComponent(BattleObjectComponentType.Buff)
		if _buffCom then
			for _, _buffStr in pairs(_playerSummondBuffList) do
				_buffGroupId = tonumber(_buffStr)
				_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _obj, nil, nil))
				--if CheckLogLevel(LogLevel.log) then
				--	LogTools.LogByLevel(LogLevel.log, "召唤物添加关卡默认buff", "buffGroupId", _buffGroupId, "netId", self.__netId, "objId", _obj:GetObjectId())
				--end
			end
		end
		
		_skillCom = _obj:GetComponent(BattleObjectComponentType.Skill)
		if _skillCom then
			for _, _talentStr in pairs(_playerSummondTalentList) do
				_talentId = tonumber(_talentStr)
				_skillCom:AddTalentSkill(_talentId, 1, 1)
				--if CheckLogLevel(LogLevel.log) then
				--	LogTools.LogByLevel(LogLevel.log, "召唤物添加关卡默认被动", "_talentId", _talentId, "netId", self.__netId, "objId", _obj:GetObjectId())
				--end
			end
		end
		
	end
	
end

------------------------------------------------------------------------------------------------------------------------
function BattleUnit_SummonedMons:GetL2SMessageData()
	local SummondMonsUnitInfo_L2V = {}
    SummondMonsUnitInfo_L2V.netId = self:GetNetId()
	SummondMonsUnitInfo_L2V.alive = self.__alive
	SummondMonsUnitInfo_L2V.createTime = self.__createTime
	---@type BattleUnitCom_Subordination
	local _subordinationCom = self:GetComponent(BattleUnitComponentType.Subordination)
	SummondMonsUnitInfo_L2V.SubordinateNetId = _subordinationCom:GetSubordinatedNetId()
	SummondMonsUnitInfo_L2V.SubordinateObjId = _subordinationCom:GetSubordinatedObjId()
	
	---@type BattleUnitCom_Camp
	local _campCom = self:GetComponent(BattleUnitComponentType.Camp)
	SummondMonsUnitInfo_L2V.firstCamp = _campCom:GetFirstCamp()
	SummondMonsUnitInfo_L2V.secCamp = _campCom:GetSecCamp()
    SummondMonsUnitInfo_L2V.currentObjectId = self:GetCurrentHeroObjectId()
	
	local _objectInfoList = {}
	---@type BattleObject_SummonedMons[]
	local _objectList = self:GetTypeObjectList(BattleObjectType.SummonedMons)
	for i = 1, #_objectList do
		local _summmondMonsObj = _objectList[i]
		table.insert(_objectInfoList, _summmondMonsObj:GetL2SMessageData())
	end
	SummondMonsUnitInfo_L2V.objectList = _objectInfoList

	local _moveInfo = {}
	---@type ActionStateManage
	local _actionManager = self:GetActionManager()
	_moveInfo.position = _actionManager:GetPosition()
	_moveInfo.rotation = _actionManager:GetRotation()
	_moveInfo.v = _actionManager:GetVelocity()
	_moveInfo.accelerate = Vector3.zero_local()
	_moveInfo.moveParam = Vector3.zero_local()
	_moveInfo.cameraParam = Vector3.zero_local()
	_moveInfo.type = 0
	SummondMonsUnitInfo_L2V.moveInfo = _moveInfo
	
	SummondMonsUnitInfo_L2V.scale = _actionManager:GetScale()
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = self.__componentDic[BattleUnitComponentType.UnitProp]
	SummondMonsUnitInfo_L2V.UnitProps = _unitPropCom and _unitPropCom:GetCreateSyncMessage_L2V() or {}
	---@type BattleUnitCom_CoverShield
	local _shieldCom = self.__componentDic[BattleUnitComponentType.CoverShield]
	SummondMonsUnitInfo_L2V.coverShieldInfo = _shieldCom and _shieldCom:GetCreateSyncMessage_L2V()

	SummondMonsUnitInfo_L2V.SummondMonsDicId = self:GetCurrentHeroObject():GetDicId()
	SummondMonsUnitInfo_L2V.targetPointId = self:GetOriginalGenerateInfo().targetPointId
	return SummondMonsUnitInfo_L2V
end

return BattleUnit_SummonedMons
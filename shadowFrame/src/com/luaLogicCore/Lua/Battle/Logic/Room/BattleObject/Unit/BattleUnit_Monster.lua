---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/01/27 11:25
--- Describe:
---

---@class BattleUnit_Monster : BattleUnitBase
BattleUnit_Monster = class(BattleUnitBase, "BattleUnit_Monster")

---@public
---@param _battleCreateUnitParam BattleCreateUnitParam
---@param _monsterObjectDic BattleObject_MonsterObject[]
function BattleUnit_Monster:Init(_battleCreateUnitParam, _monsterObjectDic, _currentObjectId)
	--if CheckLogLevel(LogLevel.logErr) then
	--	LogTools.LogByLevel(LogLevel.log, "BattleUnit_Monster", "Init", _battleCreateUnitParam.position)
	--end
	self:__Init(BattleUnitType.Monster, _battleCreateUnitParam, _monsterObjectDic, _currentObjectId)
	self:__InitComponents(_battleCreateUnitParam)
	self.__actionManager:Spawn()
end

---@private
---@param _battleCreateUnitParam BattleCreateUnitParam
function BattleUnit_Monster:__InitComponents(_battleCreateUnitParam)
	---@type BattleUnitComponentManager
	local _comManager = self:GetBattleRoom().battleUnitManager:GetUnitComponentManager()
	
	---@type BattleUnitCom_TagSelector
	local _tagCom = _comManager:AddComponent(self, BattleUnitComponentType.TagSelector)
	_tagCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = _comManager:AddComponent(self, BattleUnitComponentType.UnitProp)
	_unitPropCom:Init(self)
	
	---@type BattleUnitCom_Subordination
	local _subordinationCom = _comManager:AddComponent(self, BattleUnitComponentType.Subordination)
	_subordinationCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_Camp
	local _campCom = _comManager:AddComponent(self, BattleUnitComponentType.Camp)
	_campCom:Init(self, _battleCreateUnitParam.firstCamp, _battleCreateUnitParam.secCamp)
	
	---@type BattleUnitCom_Hatred
	local _hatredCom = _comManager:AddComponent(self, BattleUnitComponentType.Hatred)
	_hatredCom:Init(self)
	
	---@type BattleUnitCom_CoverShield
	local _shieldCom = _comManager:AddComponent(self, BattleUnitComponentType.CoverShield)
	_shieldCom:Init(self, _battleCreateUnitParam)
	
	---@type BattleUnitCom_PathFind
	local _pathFindCom = _comManager:AddComponent(self, BattleUnitComponentType.PathFind)
	_pathFindCom:Init(self)
	
	---@type BattleUnitCom_PositionSet
	local _posSetCom = _comManager:AddComponent(self, BattleUnitComponentType.PosSet)
	_posSetCom:Init(self)
	
	---@type BattleUnitCom_Rotate
	local _rotateCom = _comManager:AddComponent(self, BattleUnitComponentType.Rotate)
	_rotateCom:Init(self)
	
	---@type BattleUnitCom_Behav
	local _behavCom = _comManager:AddComponent(self, BattleUnitComponentType.Behav)
	_behavCom:Init(self)
	
end

---添加关卡初始buff和被动
function BattleUnit_Monster:AddLevelInitBuffAndTalent()
	local _heroObjectList = self:GetTypeObjectList(BattleObjectType.MonsterHero)
	---@type NewLevelInstance
	local _levelXls = self:GetBattleRoom().battleLevelManager.levelConfigManager:GetLevelInstanceXls()
	local _weatherXls = self.battleRoom.battleLevelManager.levelConfigManager:GetWeatherTypeXls()
	local _monsterBuffList = {}
	local _monsterTalentList = {}
	local _playerBuffList = {}
	local _playerTalentList = {}

	for _,buffId in pairs(_levelXls.newLevelMonsterBuff) do
		_monsterBuffList[buffId] = buffId
	end
	for _,buffId  in pairs(_levelXls.newLevelMonsterTalent) do
		_monsterTalentList[buffId] = buffId
	end
	for _,buffId  in pairs(_levelXls.newLevelLeaderBuff) do
		_playerBuffList[buffId] = buffId
	end
	for _,buffId  in pairs(_levelXls.newLevelLeaderTalent) do
		_playerTalentList[buffId] = buffId
	end
	if _weatherXls then
		for _,buffId in pairs(_weatherXls.newLevelMonsterBuff) do
			_monsterBuffList[buffId] = buffId
		end
		for _,buffId  in pairs(_weatherXls.newLevelMonsterTalent) do
			_monsterTalentList[buffId] = buffId
		end
		for _,buffId  in pairs(_weatherXls.newLevelLeaderBuff) do
			_playerBuffList[buffId] = buffId
		end
		for _,buffId  in pairs(_weatherXls.newLevelLeaderTalent) do
			_playerTalentList[buffId] = buffId
		end
	end
	
	---@type BattleUnitCom_Camp
	local _campCom = self:GetComponent(BattleUnitComponentType.Camp)
	local _buffGroupId
	local _talentId
	if _campCom:CheckFirstCamp(BattleUnitCampType.Player) then --玩家方怪物
		for _, _obj in pairs(_heroObjectList) do

			---@type BattleObjCom_Buff
			local _buffCom = _obj:GetComponent(BattleObjectComponentType.Buff)
			if _buffCom then
				for _, _buffStr in pairs(_playerBuffList) do
					_buffGroupId = tonumber(_buffStr)
					_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _obj, nil, nil))
					--if CheckLogLevel(LogLevel.logErr) then
					--	LogTools.LogByLevel(LogLevel.log, "添加关卡默认buff", "buffGroupId", _buffGroupId, "netId", self.__netId, "objId", _obj:GetObjectId())
					--end
				end
			end
			
			---@type BattleObjCom_Skill
			local _skillCom = _obj:GetComponent(BattleObjectComponentType.Skill)
			if _skillCom then
				for _, _talentStr in pairs(_playerTalentList) do
					_talentId = tonumber(_talentStr)
					_skillCom:AddTalentSkill(_talentId, 1, 1)
				end
			end
		end
	elseif _campCom:CheckFirstCamp(BattleUnitCampType.Monster) then --怪物方怪物
		for _, _obj in pairs(_heroObjectList) do

			---@type BattleObjCom_Buff
			local _buffCom = _obj:GetComponent(BattleObjectComponentType.Buff)
			if _buffCom then
				for _, _buffStr in pairs(_monsterBuffList) do
					_buffGroupId = tonumber(_buffStr)
					_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _obj, nil, nil))
					--LogTools.LogByLevel(LogLevel.log, "添加关卡默认buff", "buffGroupId", _buffGroupId, "netId", self.__netId, "objId", _obj:GetObjectId())
				end
			end

			---@type BattleObjCom_Skill
			local _skillCom = _obj:GetComponent(BattleObjectComponentType.Skill)
			if _skillCom then
				for _, _talentStr in pairs(_monsterTalentList) do
					_talentId = tonumber(_talentStr)
					_skillCom:AddTalentSkill(_talentId, 1, 1)
				end
			end
		end
	end
end

---初始化怪物自身的默认buff
---这个是怪物自身配置的，不是关卡配置的
---@public
function BattleUnit_Monster:AddUnitDefaultBuff()
	local _monsterObjList = self:GetTypeObjectList(BattleObjectType.MonsterHero)
	for _, _monsObj in pairs(_monsterObjList) do
		---@type BattleObjCom_Buff
		local _buffCom = _monsObj:GetComponent(BattleObjectComponentType.Buff)
		if _buffCom then

			---关卡传进来的（不是配的关卡BUFF）
			local _buffIdList = self:GetBattleRoom().levelMonsterBuffIds
			if _buffIdList then
				for _, _buffGroupId in pairs(_buffIdList) do
					if _buffGroupId and _buffGroupId ~= 0 then
						_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _monsObj, nil, nil))
					end
				end
			end
			
			---其他功能动态增加的
			_buffIdList = self:GetBattleRoom().dynamicMonsterBuffIds
			if _buffIdList then
				for _, _buffGroupId in pairs(_buffIdList) do
					if _buffGroupId and _buffGroupId ~= 0 then
						_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _monsObj, nil, nil))
					end
				end
			end

			---怪物表配置的
			local _buffGroupList = _monsObj:GetDataInstanceXls().defaultBuff
			if #_buffGroupList > 0 then
				for _, _buffGroupId in pairs(_buffGroupList) do
					if _buffGroupId and _buffGroupId ~= 0 then
						_buffCom:AddBattleBuff(BattleBuffService:GenerateCastBuffTemplate(_buffGroupId, _monsObj, nil, nil))
					end
				end
			end
		end
	end
end
------------------------------------------------------------------------------------------------------------------------
function BattleUnit_Monster:GetL2SMessageData()
	local _monsterUnitInfo_L2S = {}
    _monsterUnitInfo_L2S.netId = self:GetNetId()
	_monsterUnitInfo_L2S.alive = self.__alive
	_monsterUnitInfo_L2S.createTime = self.__createTime
	---@type BattleUnitCom_Camp
	local _campCom = self:GetComponent(BattleUnitComponentType.Camp)
	_monsterUnitInfo_L2S.firstCamp = _campCom:GetFirstCamp()
	_monsterUnitInfo_L2S.secCamp = _campCom:GetSecCamp()
    _monsterUnitInfo_L2S.currentObjectId = self:GetCurrentHeroObjectId()
	
	local _objectInfoList = {}
	---@type BattleObject_MonsterObject[]
	local _objectList = self:GetTypeObjectList(BattleObjectType.MonsterHero)
	table.sort(_objectList, function(a, b)
		return a:GetTeamPos() < b:GetTeamPos()
	end)
	for i = 1, #_objectList do
		local _monsterObject = _objectList[i]
		table.insert(_objectInfoList, _monsterObject:GetL2SMessageData())
	end
	_monsterUnitInfo_L2S.objectList = _objectInfoList

	local _moveInfo = {}
	---@type ActionStateManage
	local _actionManager = self:GetActionManager()
	_moveInfo.position = _actionManager:GetPosition()
	_moveInfo.rotation = _actionManager:GetRotation()
	_moveInfo.v = _actionManager:GetVelocity()
	_moveInfo.accelerate = Vector3.zero_local()
	_moveInfo.moveParam = Vector3.zero_local()
	_moveInfo.cameraParam = Vector3.zero_local()
	_moveInfo.type = 0
	_monsterUnitInfo_L2S.moveInfo = _moveInfo
	
	_monsterUnitInfo_L2S.scale = _actionManager:GetScale()
	--local _protoHashInt2FloatList = {}
	--for _key, _value in pairs(self.__unitPropDic) do
	--	local _protoHashInt2Float = {}
	--	_protoHashInt2Float.key = ProtoEnumTool.GetPropertyId(_key)
	--	_protoHashInt2Float.value = _value
	--	table.insert(_protoHashInt2FloatList, _protoHashInt2Float)
	--end
	
	---@type BattleUnitCom_UnitProp
	local _unitPropCom = self.__componentDic[BattleUnitComponentType.UnitProp]
	_monsterUnitInfo_L2S.UnitProps = _unitPropCom:GetCreateSyncMessage_L2V()
	---@type BattleUnitCom_CoverShield
	local _shieldCom = self.__componentDic[BattleUnitComponentType.CoverShield]
	_monsterUnitInfo_L2S.coverShieldInfo = _shieldCom and _shieldCom:GetCreateSyncMessage_L2V()
	---@type LevelUnit_Monster
	local _levelUnit = self:GetBattleRoom().battleLevelManager.levelUnitManager:GetLevelUnit(self.__levelUnitId)
	_monsterUnitInfo_L2S.bossShow = (_levelUnit.bossShow == true)
	_monsterUnitInfo_L2S.targetPointId = self:GetOriginalGenerateInfo().targetPointId
	
	return _monsterUnitInfo_L2S
end

return BattleUnit_Monster
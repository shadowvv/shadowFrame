---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2022/01/13 11:00
--- Describe: 战前剧情阶段(这个东西需不需要玩家点击？？？？)
---

---@class BattleLevelStage_PreBattlePlot : BattleLevelStageBase
BattleLevelStage_PreBattlePlot = class(BattleLevelStageBase, "BattleLevelStage_PreBattlePlot")

function BattleLevelStage_PreBattlePlot:OnEnter()
    self:__OnEnter()

    if self.battleStageManager.driveStage then

        -- 播放自定义剧情
        local _battleOper = self.battleRoom.battleLevelManager.levelConfigManager:GetBattleType():GetOper()
        local levelPlotDatas = _battleOper:GetPreBattlePlots()

        if levelPlotDatas and #levelPlotDatas > 0 then
            for i = 1, #levelPlotDatas do
                local plotData = levelPlotDatas[i]
                ---@type function
                local callback = nil
                if i == #levelPlotDatas then
                    -- 仅最后一段剧情，回调结束
                    callback = BattleLevelStage_PreBattlePlot.__OnPlayFinishCallback
                end
                -- 播放剧情
                self.battleRoom.battlePlayerActManager:StartPlayPlot(plotData.id, plotData.type, tostring(plotData.id),
                        callback, nil, false)
            end
            -- 有自定义剧情，就只播自定义剧情
            return
        end

        -- 播放编辑器的剧情
        local _levelConfigData = self.battleRoom.battleLevelManager.levelConfigManager:GetLevelEditorConfig()
        if _levelConfigData then
            local editorPlotDatas = _levelConfigData.startPlot
            if editorPlotDatas and #editorPlotDatas > 0 then
                for i = 1, #editorPlotDatas do
                    local plotData = editorPlotDatas[i]
                    ---@type function
                    local callback = nil
                    if i == #editorPlotDatas then
                        -- 仅最后一段剧情，回调结束
                        callback = BattleLevelStage_PreBattlePlot.__OnPlayFinishCallback
                    end
                    -- 播放剧情
                    self.battleRoom.battlePlayerActManager:StartPlayPlot(plotData.id, plotData.type, plotData.param,
                            callback, nil, false)
                end
                return
            end
        end

        -- 没有剧情数据，直接结束
        BattleLevelStage_PreBattlePlot.__OnPlayFinishCallback(self.battleRoom)
    end
end

-- 阶段超时
function BattleLevelStage_PreBattlePlot:OnStageTimeOut()
    self:__OnStageTimeOut()

    if self.battleStageManager.driveStage then
        self.battleRoom.battlePlayerActManager:StopAllPlayPlot()
    end
end

---@param _battleRoom BattleRoom
function BattleLevelStage_PreBattlePlot.__OnPlayFinishCallback(_battleRoom)
    -- 进下一阶段
    _battleRoom.outputDataSource:BattleLevelGoToStage(BattleLevel_Define_StageEnum.ShowBattleStart)
end

return BattleLevelStage_PreBattlePlot
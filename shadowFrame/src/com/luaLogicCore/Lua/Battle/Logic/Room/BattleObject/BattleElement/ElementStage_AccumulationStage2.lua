---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hejincheng.
--- DateTime: 2022/3/2 19:06

require "Lib/class"

---@class ElementStage_AccumulationStage2 : ElementStageBase
ElementStage_AccumulationStage2 = class(ElementStageBase, 'ElementStage_AccumulationStage2');

function ElementStage_AccumulationStage2:Init(_index, _stageManager)
    self:__Init(_index, _stageManager)
    local _elementStackEffect = self.elementStackEffect
    self.reduceSpeed = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_REDUCE_SPEED_K_INDEX] or 0
    self.timeOut = _elementStackEffect.reduceSpeed[BATTLE_ELEMENT_CONST.ELEMENT_REDUCE_TIME_B_INDEX] or 0
end

function ElementStage_AccumulationStage2:OnEnter()
    self:__OnEnter()
    if CheckLogLevel(LogLevel.log) and LogTools.ElementLog then
        local _targetObjectLog = "[" .. tostring(self.battleObjComElement.__object:GetDicId()) .. "]"
        local _unit = self.battleObjComElement.__object:GetParentUnit()
        if _unit:GetNetId() then
            _targetObjectLog = "[" .. self.battleRoom.battleUnitManager:GetBattleUnitTypeName(_unit:GetUnitType()) .. "][" .. _unit:GetNetId() .. "]" .. _targetObjectLog
        end
        LogTools.LogByLevel(LogLevel.log, "元素", "元素[" .. GetBattleElementNameById(self.elementId) .. "]", "目标" .. _targetObjectLog, "<color=#00FF00>进入匀速衰减阶段</color>",
                "衰减速度", self.reduceSpeed,
                "衰减时间", self.timeOut,
                "当前时间", TimeUtils.battleNow(self.battleId),
                "元素当前值", self.battleObjComElement:GetElementCurrentValue(self.elementId)
        )
    end
end

--- 获取衰减速度
function ElementStage_AccumulationStage2:GetReduceSpeed()
    return self.reduceSpeed
end

---@param _time number 时间
---@return number 元素量
function ElementStage_AccumulationStage2:__ConvertTimeToValue(_time)
    local _maxValue = self.stateManager.battleObjComElement:GetElementMaxValue(self.elementId)
    -- 匀速衰减
    return _maxValue * self:GetReduceSpeed() * _time
end

---@param _value number 元素量
---@return number 时间
function ElementStage_AccumulationStage2:__ConvertValueToTime(_value)
    local _maxValue = self.stateManager.battleObjComElement:GetElementMaxValue(self.elementId)
    return _value / self.reduceSpeed * _maxValue
end

-- 元素改变
---@public
function ElementStage_AccumulationStage2:OnElementChange(_newValue, _oldValue)
    self:__OnElementAdd(_newValue, _oldValue)
    if _newValue > _oldValue then
        -- 元素增加，重置为初始阶段
        self.stateManager:ResetInitStage()
    end
end

-- 元素效果
---@public
function ElementStage_AccumulationStage2:OnElementEffect()
    self:__OnElementEffect()
    self.stateManager:GoToStage(ElementStage_Define_StageEnum.MaxReduceStage1, false)
end

return ElementStage_AccumulationStage2;

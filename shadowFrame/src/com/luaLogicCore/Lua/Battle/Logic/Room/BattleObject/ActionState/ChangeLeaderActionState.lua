---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hejincheng.
--- DateTime: 2022/1/19 14:59

require "Lib/class"
require "Battle/Logic/Room/BattleObject/ActionState/ActionState"

---@class ChangeLeaderActionState:ActionState
ChangeLeaderActionState = class(ActionState, 'ChangeLeaderActionState');

function ChangeLeaderActionState:ctor(_leaderNetId)
    self.leaderNetId = _leaderNetId;
end

-- 切换行为
---@param _actionStateManager ActionStateManage
---@return boolean
---@overload ActionState:EnterAction
function ChangeLeaderActionState:EnterAction(_actionStateManager)
    ---@type ActionState
    local super = self.super
    if not super.EnterAction(_actionStateManager) then
        return false;
    end

    ---@type BattlePlayer
    local battlePlayer = _actionStateManager:GetObject();
    -- 判断玩家是否有这个角色
    if battlePlayer:GetLeaderManager():GetLeader(self.leaderNetId) == nil then
        LogTools.Error("ChangeLeaderAction", "玩家没有角色" .. tostring(self.leaderNetId))
        return false;
    end

    ---@type number
    local curLeaderId = battlePlayer:GetLeaderManager():GetCurrentLeaderNetId();
    -- 判断是否是当前角色
    --if curLeaderId == self.leaderNetId then
    --    LogTools.Error("ChangeLeaderAction", "玩家已经是角色" .. tostring(curLeaderId))
    --    return false;
    --end

    return true;
end

---@param _actionStateManager ActionStateManage
---@param _dt number
---@overload
function ChangeLeaderActionState:DoAction(_actionStateManager, _dt)
    ---@type BattlePlayer
    local battlePlayer = _actionStateManager:GetObject();
    ---@type BattlePlayerLeaderManager
    local leaderManager = battlePlayer:GetLeaderManager();
    -- 修改当前角色
    leaderManager:SetCurrentLeader(self.leaderNetId);

    _actionStateManager:Exit(self);
    _actionStateManager:Idle();

    local changeLeaderOutput = {
        curNetId = leaderManager:GetCurrentLeaderNetId();
        curPos = battlePlayer:GetActionManager():GetPosition();
    }

    local battleUnitOutputData = {};
    battleUnitOutputData.netId = _actionStateManager:GetObject():GetNetId();
    battleUnitOutputData.playerChangeLeaderInfo = changeLeaderOutput;

    return battleUnitOutputData;
end

---@return number
function ChangeLeaderActionState:GetId()
    return 16;
end

return ChangeLeaderActionState;
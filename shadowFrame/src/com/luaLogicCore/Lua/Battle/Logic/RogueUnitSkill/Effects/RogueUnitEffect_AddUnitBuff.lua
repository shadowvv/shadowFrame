---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jiangxuechen
--- DateTime: 2023/07/28 20:01
--- Describe:
---

---@class RogueUnitEffect_AddUnitBuff : RogueUnitSkillEffectBase
RogueUnitEffect_AddUnitBuff = class(RogueUnitSkillEffectBase, "RogueUnitEffect_AddUnitBuff")

---@private
function RogueUnitEffect_AddUnitBuff:__InitBuffCastTemplates()
	local _castUnit = self:GetUnit()
	local _castObjId = _castUnit:GetCurrentHeroObjectId()
	--todo:这里先不传试试~~
	local _rogueSkillId = self:GetAction():GetRogueUnitSkill():GetId()
	local _tab = {}
	local _xls = self:GetXlsData()
	for i = 1, #_xls.params do
		local _buffCastTemplate = BattleBuffService:GenerateUnitCastBuffTemplate(math.floor(_xls.params[i]), _castUnit, _castObjId, nil)
		table.insert(_tab, _buffCastTemplate)
	end
	---@private
	---@type BattleBuffCastTemplate[]
	self.__buffCastTemplateList = _tab
	---@private
	---@type number[]
	self.__checkDic = {}
end

---@public
---@param _targetObjList BattleObjectBase[]
function RogueUnitEffect_AddUnitBuff:OnTrig(_targetObjList)
	self:__OnTrig(_targetObjList)
	if not self.__buffCastTemplateList then
		---这里不能放到INIT中进行，因为在Unit创建时就先把effect信息初始化好了，此时unit还没加到UnitManager的列表中，会出现buff找不到施法者unit的情况
		self:__InitBuffCastTemplates()
	end
	
	if CheckLogLevel(LogLevel.log) and LogTools.RogueUnitSkillLog then
		LogTools.LogByLevel(LogLevel.log, "肉鸽主公技", "    RogueUnitEffect_AddUnitBuff:OnTrig", "Effect触发", "所属ActionId", self:GetAction():GetId(), "当前Effect ID", self:GetId(), "当前Effect类型", self:GetEffectTypeDesc(), "_targetObjList", #_targetObjList)
	end
	
	local _checkDic = self.__checkDic
	TableUtil.ClearTable(_checkDic)

	---@type BattleUnitBase
	local _unit
	---@type number
	local _netId
	for _, _obj in pairs(_targetObjList) do
		_unit = _obj:GetParentUnit()
		_netId = _unit:GetNetId()
		if not _checkDic[_netId] then
			_checkDic[_netId] = 1
			self:__dealAddBuff(_unit:GetComponent(BattleUnitComponentType.Buff))
		end
	end
end

---@private
---@param _buffCom BattleUnitCom_Buff
function RogueUnitEffect_AddUnitBuff:__dealAddBuff(_buffCom)
	if not _buffCom then return end
	
	local _list = self.__buffCastTemplateList
	for i = 1, #_list do
		if CheckLogLevel(LogLevel.log) and LogTools.RogueUnitSkillLog then
			LogTools.LogByLevel(LogLevel.log, "肉鸽主公技", "    RogueUnitEffect_AddUnitBuff:__dealAddBuff", "targetNetId", _buffCom:GetUnit():GetNetId(), "buffGroupId", _list[i].buffGroupId)
		end
		_buffCom:AddBattleBuff(_list[i])
	end
end

return RogueUnitEffect_AddUnitBuff
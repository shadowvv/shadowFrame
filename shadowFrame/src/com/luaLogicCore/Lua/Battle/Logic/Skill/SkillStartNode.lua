---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/2/16 16:20

require "Lib/class"
require "Battle/Logic/Skill/SkillBaseNode"

---@class SkillStartNode : SkillBaseNode 技能开始节点
---@field nodeId number 节点id
---@field nextNodes SkillNodeExitData[] 子节点
SkillStartNode = class(SkillBaseNode, 'SkillStartNode');

---@param _nodeId number 节点id
---@param _once boolean 只执行一次
---@param _nextNodes SkillNodeExitData[] 子节点
---@param _specialExit SkillNodeExitData[] 特殊出口
function SkillStartNode:ctor(_nodeId,_once,_nextNodes,_specialExit)
    self.nodeId = _nodeId;
    self.once = _once;
    self.nextNodes = _nextNodes;
    self.specialExit = _specialExit;
end

---执行技能节点
---@param _actionStateManager ActionStateManage 行为管理器
---@param _dt number 更新时间
---@param _netId number 单位id
---@param _skillModel SkillModel 技能配置
---@param _currentSkillState SkillActionState 当前技能状态
---@return boolean,table 是否执行结束,执行行为输出数据
function SkillStartNode:DoAction(_actionStateManager, _dt, _netId, _skillModel, _currentSkillState)
    local curHeroObject = _actionStateManager:GetUnit():GetCurrentHeroObject()
    local battleRoom = GetBattleRoom(_actionStateManager.battleId)
    if not _skillModel.onlyCheck then
        ---@type BattleObjCom_Skill
        local componentSkill = _actionStateManager:GetUnit():GetCurrentHeroObject():GetComponent(BattleObjectComponentType.Skill);

        ---@type BattleObjCom_Weapon
        local weapon = curHeroObject:GetComponent(BattleObjectComponentType.Weapon);
        if weapon and not weapon:CostUseSkill(_skillModel.skillId, battleRoom.inputDataSource:GetSkillFinalParam(_skillModel.manaCast, _skillModel.skillId, componentSkill:GetSkillLevel(_skillModel.skillId))) then
            _actionStateManager:ExitSkill(true);
            _actionStateManager:Idle();
            return true, nil;
        end

        ---@type BattleObjCom_Property
        local property = curHeroObject:GetComponent(BattleObjectComponentType.Property);
        local curSuperMana = property:GetPropertyByName(BattlePropertyEnum.Jizou_Cur);

        local superCast = _actionStateManager.battleRoom.inputDataSource:GetSkillFinalParam(_skillModel.superCast, _skillModel.skillId, componentSkill:GetSkillLevel(_skillModel.skillId))
        if curSuperMana < superCast then
            _actionStateManager:ExitSkill(true);
            _actionStateManager:Idle();
            return true, nil;
        end
        property:ChangeJizouEn(-superCast)
    end

    battleRoom.battleLogicEventService:OnTriggerSkillStartEvent(_netId,curHeroObject:GetObjectId(),_skillModel.skillId);
    return true, nil;
end

---返回节点类型
---@public
---@return number 节点类型
function SkillStartNode:GetType()
    return 11;
end

return SkillStartNode;
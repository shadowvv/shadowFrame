---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/7/5 16:41

require "Lib/class"
require "Battle/Logic/TalentSkill/TalentSkillResult/TalentSkillResultBase"

---@class TalentSkillChangeBuffCurrentTimeResult : TalentSkillResultBase
TalentSkillChangeBuffCurrentTimeResult = class(TalentSkillResultBase, 'TalentSkillChangeBuffCurrentTimeResult');

function TalentSkillChangeBuffCurrentTimeResult:ctor(_battleId)
    self.battleId = _battleId
    self.battleRoom = GetBattleRoom(self.battleId)
    self.max = 0;
    self.triggerOnlyOnceInstId = {};
end

---触发被动技能
---@public
---@param _battleObjectBase BattleObjectBase
---@param _count number
---@param _talentSkillConfig TalentSkill
---@param _skillResult SkillResult
---@param _talentSkill BattlePlayerTalentSkill 被动技能
---@param _isReTrigger boolean 重新触发
function TalentSkillChangeBuffCurrentTimeResult:Trigger(_battleObjectBase,_count,_talentSkillConfig,_skillResult,_talentSkill,_isReTrigger)

    ---@type BattleObjCom_Buff
    local buffComp = _battleObjectBase:GetComponent(BattleObjectComponentType.Buff);
    if not buffComp then
        self.max = 0;
        return;
    end
    local buffId = _skillResult.parm1;
    local changeTime = _skillResult.parm2 * (1 + buffComp:GetTalentSkillUpPercent(_talentSkillConfig.sourceType)) * _count;
    if not buffComp:CheckBuffExist(buffId) then
        self.max = 0;
        return;
    end
    if _skillResult.parm3 and self.max >= _skillResult.parm3 then
        return;
    end
    if _skillResult.parm5 ~= 1 then
        buffComp:ChangeBuffCurrentTime(buffId,_skillResult.parm4,changeTime,{});
    else
        local buffInstIds =  buffComp:ChangeBuffCurrentTime(buffId,_skillResult.parm4,changeTime,self.triggerOnlyOnceInstId);
        for i, v in pairs(buffInstIds) do
            self.triggerOnlyOnceInstId[v] = 1;
        end
    end
    _talentSkill:AddTriggeredObject(_battleObjectBase:GetObjectId(),_count);
    self.max = self.max + changeTime;
end

---释放被动技能
---@public
---@param _skillResult SkillResult
---@param _targetObjectId number 伤害目标objectId
---@param _count number 触发次数
---@param _talentSkill BattlePlayerTalentSkill
function TalentSkillChangeBuffCurrentTimeResult:Release(_skillResult, _targetObjectId,_count,_talentSkill)
    self.max = 0;
end


---被动技能触发类型
---@return number 被动技能触发类型
function TalentSkillChangeBuffCurrentTimeResult:GetType()
    return 10;
end

return TalentSkillChangeBuffCurrentTimeResult;
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/5/10 16:58

require "Lib/class"

---@class TalentSkillEnemyDeadTrigger : table
TalentSkillEnemyDeadTrigger = class(nil, 'TalentSkillEnemyDeadTrigger');

function TalentSkillEnemyDeadTrigger:ctor(_battleId)
    ---@type number
    self.battleId = _battleId
    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
    self.battleRoom = GetBattleRoom(self.battleId)
    self.count = 0;
end

---@public
---击中目标回调
---@param _talentSkillTrigger SkillTrigger
---@param _targetNetId number 伤害目标netId
---@param _targetObjectId number 伤害目标objectId
---@param _sourceNetId number 伤害类型Id
---@param _sourceObjectId number 伤害来源类型
function TalentSkillEnemyDeadTrigger:OnObjectDead(_talentSkillTrigger,_battleObject, _targetNetId, _targetObjectId, _sourceNetId, _sourceObjectId)
    if TimeUtils.battleNow(self.battleId) - self.lastTriggerTime < _talentSkillTrigger.parm6 then
        return;
    end

    if _battleObject:GetParentUnit():GetNetId() == _targetNetId then
        return;
    end

    if _talentSkillTrigger.parm2 and _talentSkillTrigger.parm2 ~= 0 then
        ---@type BattleObjCom_Buff
        local buffCom = _battleObject:GetComponent(BattleObjectComponentType.Buff);
        if buffCom and not buffCom:CheckBuffExist(math.floor(_talentSkillTrigger.parm2)) then
            buffCom = _battleObject:GetParentUnit():GetComponent(BattleUnitComponentType.Buff);
            if buffCom and not buffCom:CheckBuffExist(math.floor(_talentSkillTrigger.parm2)) then
                return;
            end
        end
    end

    if _talentSkillTrigger.parm3 and _talentSkillTrigger.parm3 ~= 0 then
        ---@type BattleUnitBase
        local targetUnit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if targetUnit then
            ---@type BattleObjectBase
            local targetObject = targetUnit:GetHeroObject(_targetObjectId);
            if targetObject then
                ---@type BattleObjCom_Buff
                local buffCom = targetObject:GetComponent(BattleObjectComponentType.Buff);
                if buffCom and not buffCom:CheckBuffExist(math.floor(_talentSkillTrigger.parm3)) then
                    buffCom = targetObject:GetParentUnit():GetComponent(BattleUnitComponentType.Buff);
                    if buffCom and not buffCom:CheckBuffExist(math.floor(_talentSkillTrigger.parm3)) then
                        return;
                    end
                end
            end
        end
    end

    if _targetNetId == _sourceNetId then
        return;
    end

    self.count  = self.count + 1;
end

---@public
---@param _battleObject BattleObjectBase 触发单位
---@param _talentSkillTrigger SkillTrigger 被动技能配置
---@param _talentSkill BattlePlayerTalentSkill 被动技能
function TalentSkillEnemyDeadTrigger:Check(_battleObject, _talentSkillTrigger,_talentSkill)
    if _talentSkillTrigger.parm1 > self.count then
        return 0;
    end
    local count = math.floor(self.count / _talentSkillTrigger.parm1);
    self:Reset();
    return count;
end

---@public
function TalentSkillEnemyDeadTrigger:Reset()
    self.count = 0;
end

---被动技能触发类型
---@return number 被动技能触发类型
function TalentSkillEnemyDeadTrigger:GetType()
    return 132;
end

return TalentSkillEnemyDeadTrigger;
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/5/10 16:59

require "Lib/class"

---@class TalentSkillHealTrigger : table
TalentSkillHealTrigger = class(nil, 'TalentSkillHealTrigger');

function TalentSkillHealTrigger:ctor(_battleId)
    ---@type number
    self.battleId = _battleId
    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
    self.battleRoom = GetBattleRoom(self.battleId)
    self.count = 0;
    self.targetCount = {};
    self.targetNetId = 0;
    self.targetObjectId = 0;
end

---@public
---击中目标回调
---@param _talentSkillTrigger SkillTrigger
---@param _targetNetId number 治疗目标netId
---@param _targetObjectId number 治疗目标objectId
---@param _castSkillId number 治疗技能Id
function TalentSkillHealTrigger:OnHealSomeone(_talentSkillTrigger,_battleObject,_targetNetId,_targetObjectId,_castSkillId)
    if TimeUtils.battleNow(self.battleId) - self.lastTriggerTime < _talentSkillTrigger.parm6 then
        return;
    end

    ---@type Skill
    local skillConfig = self.battleRoom.inputDataSource:GetDict("SKill",_castSkillId);
    if _talentSkillTrigger.parm8 and _talentSkillTrigger.parm8 ~= 0 and skillConfig then
        if skillConfig.skillType ~= _talentSkillTrigger.parm8 then
            return;
        end
    end

    if _talentSkillTrigger.parm2 and _talentSkillTrigger.parm2 == 1 then
        ---@type Leader
        local leader = _battleObject:GetInstanceXls();
        if not leader or not leader.property then
            return;
        end
        ---@type BattleUnitBase
        local targetUnit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if targetUnit then
            ---@type BattleObjectBase
            local targetObject = targetUnit:GetHeroObject(_targetObjectId);
            if targetObject then
                ---@type Leader
                local leaderTarget = targetObject:GetInstanceXls();
                if not leaderTarget then
                    return;
                end
                if leader.property ~= leaderTarget.property then
                    return;
                end
            end
        end
    end

    if _talentSkillTrigger.parm5 ~= 0 then
        if not self.targetCount[_targetObjectId] then
            self.targetCount[_targetObjectId] = 0;
        end
        self.targetCount[_targetObjectId] = self.targetCount[_targetObjectId] + 1;
        if self.targetCount[_targetObjectId] > self.count then
            self.count = self.targetCount[_targetObjectId];
            self.targetNetId = _targetNetId;
            self.targetObjectId = _targetObjectId;
        end
    else
        self.count = self.count + 1;
    end

    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
end

---@public
---@param _battleObject BattleObjectBase 触发单位
---@param _talentSkillTrigger SkillTrigger 被动技能配置
---@param _talentSkill BattlePlayerTalentSkill 被动技能
function TalentSkillHealTrigger:Check(_battleObject, _talentSkillTrigger,_talentSkill)
    if _talentSkillTrigger.parm1 > self.count then
        return 0;
    end
    local count = math.floor(self.count / _talentSkillTrigger.parm1);
    if self.targetNetId ~= 0 and self.targetObjectId ~= 0 then
        for i, v in pairs(self.targetCount) do
            local tempCount = math.floor(v / _talentSkillTrigger.parm1);
            if tempCount > 0 then
                _talentSkill:AddTriggerObject(i,tempCount);
                self.targetCount[i] = nil;
            end
        end
    end
    self:Reset();
    return count;
end

---@public
function TalentSkillHealTrigger:Reset()
    self.count = 0;
end

---被动技能触发类型
---@return number 被动技能触发类型
function TalentSkillHealTrigger:GetType()
    return 130;
end

return TalentSkillHealTrigger;
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/5/10 16:57

require "Lib/class"

---@class TalentSkillHitCountTrigger : table
TalentSkillHitCountTrigger = class(nil, 'TalentSkillHitCountTrigger');

function TalentSkillHitCountTrigger:ctor(_battleId)
    ---@type number
    self.battleId = _battleId
    self.battleRoom = GetBattleRoom(self.battleId)
    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
    self.hitCount = 0;

    self.targetHitCount = {};
    self.targetNetId = 0;
    self.targetObjectId = 0;
    self.param = nil
end

---@public
---击中目标回调
---@param _talentSkillTrigger SkillTrigger
---@param _targetNetId number 伤害目标netId
---@param _targetObjectId number 伤害目标objectId
---@param _targetType number 伤害目标类型
---@param _damageSourceId number 伤害类型Id
---@param _damageSourceType number 伤害来源类型
---@param _damage number 造成伤害
---@param _damageType number 伤害类型
---@param _isCritical boolean 是否暴击
---@param _targetDead boolean 目标是否死亡
---@param _hurtDisReduceEnum number 伤害距离衰减类型，对应 HurtDisReduceEnum 定义的值
---@param _isWeakness boolean 是否为弱点攻击
---@param _curAttachEleId number 击中时目标元素
---@param _isAccumulatedAttack boolean 是否为蓄力攻击
---@param _skillBarrageId number 技能弹幕id
function TalentSkillHitCountTrigger:OnSkillHitTarget(_talentSkillTrigger, _battleObject,_targetNetId, _targetObjectId, _targetType, _damageSourceId, _damageSourceType, _damage, _damageType, _isCritical, _targetDead,_hurtDisReduceEnum,_isWeakness,_curAttachEleId,_isAccumulatedAttack,_skillBarrageId)
    
    --技能伤害
    if _damageSourceType ~= 1 then
        return;
    end

    if TimeUtils.battleNow(self.battleId) - self.lastTriggerTime < _talentSkillTrigger.parm6 then
        return;
    end

    if _talentSkillTrigger.parm1 and _talentSkillTrigger.parm1 ~= 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        ---@type MonsterInstance
        local instance = object:GetDataInstanceXls();
        if instance.classify ~= _talentSkillTrigger.parm1 then
            return;
        end
    end

    if _talentSkillTrigger.parm3 and _talentSkillTrigger.parm3 ~= 0 then
        if _talentSkillTrigger.parm3 == -1 then
            -- -1 为任意元素(无元素不行)
            if _curAttachEleId == 0 then
                return
            end
        else
            if _curAttachEleId ~= _talentSkillTrigger.parm3 then
                return;
            end
        end
    end

    if _talentSkillTrigger.parm4 and _talentSkillTrigger.parm4 ~= 0 then
        if _hurtDisReduceEnum ~= _talentSkillTrigger.parm4 then
            return;
        end
    end

    if _talentSkillTrigger.parm8 and #_talentSkillTrigger.parm8 > 0 then
        local matchType = false;
        if _damageSourceType ~= 1 then
            return;
        end
        ---@type Skill
        local skillConfig = self.battleRoom.inputDataSource:GetDict("Skill",_damageSourceId)
        for i, v in pairs(_talentSkillTrigger.parm8) do
            if v == 0 then
                matchType = true;
            end
            if skillConfig.skillType == v then
                matchType = true;
            end
        end
        if not matchType then
            return;
        end
    end

    if _talentSkillTrigger.parm9 and _talentSkillTrigger.parm9 ~= 0 then
        local temp = 0;
        if _isWeakness then
            temp = 1;
        end
        if _talentSkillTrigger.parm9 ~= temp then
            return;
        end
    end

    if _talentSkillTrigger.parm10 and _talentSkillTrigger.parm10 ~= 0 then
        local temp = 0;
        if _isAccumulatedAttack then
            temp = 1;
        end
        if _talentSkillTrigger.parm10 == 1 then
            if temp ~= 1 then
                return
            end
        elseif _talentSkillTrigger.parm10 == 2 then
            if temp ~= 0 then
                return;
            end
        end
    end

    --- 击杀目标是否含有某buff
    if _talentSkillTrigger.parm11 and _talentSkillTrigger.parm11 ~= 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        ---@type BattleObjCom_Buff
        local buffCom = object:GetComponent(BattleObjectComponentType.Buff);
        if not buffCom then
            return;
        end
        if not buffCom:CheckBuffExist(_talentSkillTrigger.parm11) then
            return;
        end
    end

    if _talentSkillTrigger.parm12 and _talentSkillTrigger.parm12 ~= 0 then
        ---@type BattleObjCom_Buff
        local buffCom = _battleObject:GetComponent(BattleObjectComponentType.Buff);
        if not buffCom or not buffCom:CheckBuffExist(_talentSkillTrigger.parm12) then
            ---@type BattleUnitCom_Buff
            local unitBuffCom = _battleObject:GetParentUnit():GetComponent(BattleUnitComponentType.Buff);
            if not unitBuffCom or not unitBuffCom:CheckBuffExist(_talentSkillTrigger.parm12) then
                return;
            end
        end
    end

    if _talentSkillTrigger.parm13 and _talentSkillTrigger.parm13 > 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        ---@type BattleObjCom_Property
        local propCom = object:GetComponent(BattleObjectComponentType.Property);
        if not propCom then
            return;
        end

        local percent = propCom:GetPropertyPercentByName(BattlePropertyEnum.Jizou_Cur);

        if percent < _talentSkillTrigger.parm13 then
            return;
        end
    end

    if _talentSkillTrigger.parm14 and _talentSkillTrigger.parm14 ~= 0 then
        if _talentSkillTrigger.parm14 ~= _skillBarrageId then
            return;
        end
    end

    if _talentSkillTrigger.parm15 and _talentSkillTrigger.parm15 ~= 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        ---@type BattleObjCom_Property
        local propCom = object:GetComponent(BattleObjectComponentType.Property);
        local percent = propCom:GetPropertyPercentByName(BattlePropertyEnum.Hp_Cur);
        if _talentSkillTrigger.parm15 > 0 and percent < _talentSkillTrigger.parm15 then
            return;
        end
        if _talentSkillTrigger.parm15 < 0 and percent > _talentSkillTrigger.parm15*-1 then
            return;
        end
    end

    if _talentSkillTrigger.parm16 and _talentSkillTrigger.parm16 ~= 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        ---@type BattleObjCom_Element_V2
        local elementCom = object:GetComponent(BattleObjectComponentType.Element);
        if elementCom.effectingElementId <= 0 then
            return;
        end
        if _talentSkillTrigger.parm16 ~= -1 and elementCom.effectingElementId ~= _talentSkillTrigger.parm16 then
            return;
        end
    end

    if _talentSkillTrigger.parm17 and _talentSkillTrigger.parm17 ~= 0 then
        ---@type BattleUnitBase
        local unit = self.battleRoom.battleUnitManager:GetUnit(_targetNetId);
        if not unit then
            return;
        end
        ---@type BattleObjectBase
        local object = unit:GetHeroObject(_targetObjectId);
        if not object then
            return;
        end
        local find = false;
        ---@type BattleObjCom_Property
        local _propCom = unit:GetCurrentHeroObject():GetComponent(BattleObjectComponentType.Property)
        local _eleWeakList = _propCom:GetEleWeakTypeList()
        for i, v in pairs(_eleWeakList) do
            if _talentSkillTrigger.parm17 == v then
                find = true;
            end
        end
        if not find then
            return;
        end
    end

    if _talentSkillTrigger.parm5 and _talentSkillTrigger.parm5 ~= 0 then
        if not self.targetHitCount[_targetObjectId] then
            self.targetHitCount[_targetObjectId] = 0;
        end
        self.targetHitCount[_targetObjectId] = self.targetHitCount[_targetObjectId] + 1;
        if self.targetHitCount[_targetObjectId] > self.hitCount then
            self.hitCount = self.targetHitCount[_targetObjectId];
            self.targetNetId = _targetNetId;
            self.targetObjectId = _targetObjectId;
        end
    else
        self.hitCount = self.hitCount + 1;
    end

    self.param = _damage
    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
end

---@public
---@param _battleObject BattleObjectBase 触发单位
---@param _talentSkillTrigger SkillTrigger 被动技能配置
---@param _talentSkill BattlePlayerTalentSkill 被动技能
function TalentSkillHitCountTrigger:Check(_battleObject, _talentSkillTrigger,_talentSkill)
    if _talentSkillTrigger.parm2 > self.hitCount then
        return 0;
    end
    local count = math.floor(self.hitCount / _talentSkillTrigger.parm2);
    if self.targetNetId ~= 0 and self.targetObjectId ~= 0 then
        for i, v in pairs(self.targetHitCount) do
            local tempCount = math.floor(v / _talentSkillTrigger.parm2);
            if tempCount > 0 then
                _talentSkill:AddTriggerObject(i,tempCount);
                self.targetHitCount[i] = nil;
            end
        end
    end
    self:Reset();
    return count;
end

---@public
function TalentSkillHitCountTrigger:Reset()
    self.hitCount = 0;
end

---被动技能触发类型
---@return number 被动技能触发类型
function TalentSkillHitCountTrigger:GetType()
    return 102;
end

return TalentSkillHitCountTrigger;
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaopuyang.
--- DateTime: 2022/6/11 15:36

require "Lib/class"

---@class TalentSkillElementReactTrigger : table
TalentSkillElementReactTrigger = class(nil, 'TalentSkillElementReactTrigger');

function TalentSkillElementReactTrigger:ctor(_battleId)
    ---@type number
    self.battleId = _battleId
    self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
    self.targetHitCount = {};
    self.hitCount = 0;
    self.targetNetId = 0;
    self.targetObjectId = 0;
end

---@public
---@param _talentSkillTrigger SkillTrigger 被动技能配置
---@param _targetNetId number 伤害目标netId
---@param _targetObjectId number 伤害目标objectId
---@param _elementReactId number 元素Id
function TalentSkillElementReactTrigger:OnElementReact(_talentSkillTrigger, _targetNetId, _targetObjectId, _elementReactId)
    if TimeUtils.battleNow(self.battleId) - self.lastTriggerTime < _talentSkillTrigger.parm6 then
        return;
    end

    for i, v in pairs(_talentSkillTrigger.parm8) do
        if v == _elementReactId then
            if _talentSkillTrigger.parm5 ~= 0 then
                if not self.targetHitCount[_targetObjectId] then
                    self.targetHitCount[_targetObjectId] = 0;
                end
                self.targetHitCount[_targetObjectId] = self.targetHitCount[_targetObjectId] + 1;
                if self.targetHitCount[_targetObjectId] > self.hitCount then
                    self.hitCount = self.targetHitCount[_targetObjectId];
                    self.targetNetId = _targetNetId;
                    self.targetObjectId = _targetObjectId;
                end
            else
                self.hitCount = self.hitCount + 1;
            end
            self.lastTriggerTime = TimeUtils.battleNow(self.battleId);
            break;
        end
    end
end

---@public
---@param _battleObject BattleObjectBase 触发单位
---@param _talentSkillTrigger SkillTrigger 被动技能配置
---@param _talentSkill BattlePlayerTalentSkill 被动技能
function TalentSkillElementReactTrigger:Check(_battleObject, _talentSkillTrigger,_talentSkill)
    if _talentSkillTrigger.parm1 > self.hitCount then
        return 0;
    end
    local count = math.floor(self.hitCount / _talentSkillTrigger.parm1);
    if self.targetNetId ~= 0 and self.targetObjectId ~= 0 then
        for i, v in pairs(self.targetHitCount) do
            local tempCount = math.floor(v / _talentSkillTrigger.parm1);
            if tempCount > 0 then
                _talentSkill:AddTriggerObject(i,tempCount);
                self.targetHitCount[i] = nil;
            end
        end
    end
    self:Reset();
    return count;
end

---@public
function TalentSkillElementReactTrigger:Reset()
    self.hitCount = 0;
end

---被动技能触发类型
---@return number 被动技能触发类型
function TalentSkillElementReactTrigger:GetType()
    return 108;
end

return TalentSkillElementReactTrigger;